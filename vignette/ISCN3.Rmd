---
title: "ISCN 3.3 data"
author: "K Todd-Brown (ktoddbrown@ufl.edu)"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

Purpose: *This vignette describes the ISCN3 data contributions.*


# Setup

```{r setup, echo=FALSE}
library(SOCDRaH2)
library(tidyverse)
library(knitr)
library(kableExtra)
dataDir <- '~/Documents/Datasets/ISCN'

knitr::opts_chunk$set(eval=FALSE)
```

```{r fakeSetUp, eval=FALSE}
library(SOCDRaH2)
library(ggplot2)
dataDir <- 'Your/Data/Dir'
```


```{r load, eval=FALSE}
ISCN3.ls <- ISCN3_3(data_dir = dataDir)
```

Some comment on the organization of ISCN3.
Includes a description of the tables, identifying columns and descriptions of the headers.
Also need a citation with the EDI link

Creating a table to show summary statistics of the number of unique sites each dataset in the profile table has.

```{r sites}
profile_summary <- ISCN3.ls$profile %>%
  select(dataset_name_sub, site_name) %>%
  unique()%>%
  group_by(dataset_name_sub) %>% 
  tally(name = 'profile_site_count')

layer_summary <- ISCN3.ls$layer %>%
  select(dataset_name_sub, site_name) %>%
  unique()%>%
  group_by(dataset_name_sub) %>% 
  tally(name = 'layer_site_count')

knitr::kable(full_join(profile_summary, layer_summary, by = c('dataset_name_sub')) %>%
    arrange(layer_site_count), 
  caption = 'Site counts for each contributing dataset submision (dataname_sub) in the profile and layer data table.')%>%
  kable_styling()
```

# Dataset description table

```{r}
study <- ISCN3.ls$study %>% 
  select(dataset_name, `dataset_type (dataset_type)`, dataset_description) 
knitr::kable(study,
  caption = 'Site counts for each contributing dataset submision (dataname_sub) in the profile data table.')%>%
  kable_styling()
```

# Description of the tables and columns

Create a table with the table name, column name, and long description similar to what is on the EDI page.

# New section for each data contribution

Include both a description of the data sets including counts of layers and sites, histograms and tables of variables, and site map.
List data contributions from largest to smallest.

## Myers Smith

The Myers Smith data set in ISCN3 contains `r nrow(dataset_layer)` layer-level rows and `r nrow(dataset_profile)` profile-level information rows after cleaning for ISCN3.5.
ISCN3 removed repeated information in citations, so these column values were corrected and filled for ISCN3.5.
ISCN3 filled in the soil carbon stocks where bulk density and organic carbon was provided, so these columns were removed for ISCN3.5.
This data set was set in Alaska, so the Alaska Location code from the Template was used instead of the generic.

```{r warning=FALSE, message=FALSE}
datasetName <- "Myers-Smith" 

##### Extract the study information ####
dataset_study <- ISCN3.ls$study %>% 
  filter(dataset_name == datasetName) 

```

```{r warning=FALSE, message=FALSE}
##### Extract the profile information ####

#comparison for pre ISCN soc stock correction
dataset_profile_org <- profile_raw  %>%
   filter(dataset_name_sub == datasetName) %>%
   standardCast()

dataset_profile <- profile_raw  %>%
  filter(dataset_name_sub == datasetName) 

if(any(grepl('ISCN', dataset_profile$dataset_name_soc))){
  #reassign rows where the ISCN tried to fill in SOC values
  dataset_profile <- dataset_profile %>%
    group_by(dataset_name_soc) %>%
    mutate(`soc_depth (cm)` = if_else(grepl('ISCN', dataset_name_soc),
                                      rep(NA_character_, length(`soc_depth (cm)`)), `soc_depth (cm)`),
           `soc (g cm-2)` = if_else(grepl('ISCN', dataset_name_soc),
                                    rep(NA_character_, length(`soc (g cm-2)`)), `soc (g cm-2)`),
           soc_carbon_flag = if_else(grepl('ISCN', dataset_name_soc),
                                     rep(NA_character_, length(soc_carbon_flag)), soc_carbon_flag),
           soc_spatial_flag = if_else(grepl('ISCN', dataset_name_soc),
                                      rep(NA_character_, length(soc_spatial_flag)), soc_spatial_flag),
           soc_method = if_else(grepl('ISCN', dataset_name_soc), 
                                rep(NA_character_, length(soc_method)), soc_method)) %>%
    ungroup()
  
}

#remove the soc dataset since we've taken care of the ISCN notation
dataset_profile <- select(dataset_profile, -dataset_name_soc)  

if(any(count(dataset_profile, dataset_name_sub, site_name, profile_name)$n > 1)){
  #if the rows are duplicated then fill in missing values by group
  dataset_profile <- dataset_profile %>%
    group_by(dataset_name_sub, site_name, profile_name) %>%
    mutate_at(vars(-group_cols()), 
              function(xx){ifelse(sum(!is.na(xx)) == 1, rep(xx[!is.na(xx)], length(xx)),xx)}) %>% #if there is one value that isn't na then populate the rest of the entry, this fills in the
    ungroup() %>%
    unique() #collapase rows that are non-unique
}

dataset_profile <- standardCast(dataset_profile)
```

```{r warning = FALSE, message = FALSE}
##### Extract the layer infromation ####

#comparison before SOC correction
dataset_layer_org <- layer_raw %>%
  filter(dataset_name_sub == datasetName) %>%
  standardCast()

dataset_layer <- layer_raw %>%
  filter(dataset_name_sub == datasetName) 

if(any(grepl('ISCN', dataset_layer$dataset_name_soc))){
  #reassign rows where the ISCN tried to fill in SOC values
  dataset_layer <- dataset_layer %>%
    group_by(dataset_name_soc) %>%
    mutate(`soc (g cm-2)` = if_else(grepl('ISCN', dataset_name_soc),
                                    rep(NA_character_, length(`soc (g cm-2)`)), `soc (g cm-2)`),
           soc_carbon_flag = if_else(grepl('ISCN', dataset_name_soc),
                                     rep(NA_character_, length(soc_carbon_flag)), soc_carbon_flag),
           soc_method = if_else(grepl('ISCN', dataset_name_soc), 
                                rep(NA_character_, length(soc_method)), soc_method)) %>%
    ungroup()
  
}

#remove the soc dataset since we've taken care of the ISCN notation
dataset_layer <- select(dataset_layer, -dataset_name_soc) 

if(any(count(dataset_layer, dataset_name_sub, site_name, profile_name, layer_name)$n > 1)){
  #if the rows are duplicated then fill in missing values by group
  dataset_layer <- dataset_layer %>%
    group_by(dataset_name_sub, site_name, profile_name, layer_name) %>%
    mutate_at(vars(-group_cols()), 
              function(xx){ifelse(sum(!is.na(xx)) == 1, rep(xx[!is.na(xx)], length(xx)),xx)}) %>% #if there is one value that isn't na then populate the rest of the entry, this fills in the
    ungroup() %>%
    unique() #collapase rows that are non-unique
}

dataset_layer <- standardCast(dataset_layer)

```

```{r}
plotGenerate(ISCN3 = ISCN3.ls, 'Myers-Smith')
```

# Citations and bibliography

Create a table with each dataset and citation, repeat the dataset name as needed for each citation.

```{r}
#need to gap fill these or find the gap filled ones
study <- citation_raw %>% 
  select(dataset_name, citation) 
knitr::kable(study,
  caption = 'Citations for each contributing dataset submision (dataname_sub).')%>%
  kable_styling()
```


---
title: "Example of merging data files"
author: "Kathe Todd-Brown <ktoddbrown@ufl.edu>"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)

#download from EDI
ISCN3Datafile <- '~/Documents/Datasets/ISCN_new/ISCN3_layer.csv'

#Download url from Erin
#co_soils_visit <- read.csv('https://apps.fs.usda.gov/fia/datamart/CSV/CO_SOILS_VISIT.csv')
#co_soils_lab <- read.csv('https://apps.fs.usda.gov/fia/datamart/CSV/CO_SOILS_LAB.csv')
FIADBDatafile <- '~/Documents/Datasets/USDA_FIADB_RMRS/soils_lab_CO.csv'

knitr::opts_chunk$set(echo = TRUE)
```

```{r}

#read in and simplify the files to only look at bulk density

ISCN.df <- read_delim(file = ISCN3Datafile, 
                    col_types = cols(.default =col_character()),
                    delim = ';', n_max = 500) %>%
  select("dataset_name_sub", "site_name", "profile_name", "layer_name", #ID columns
         #"soc (g cm-2)", "soc_carbon_flag", "soc_method",
         "bd_method", "bd_samp (g cm-3)", "bd_tot (g cm-3)", "bd_whole (g cm-3)", "bd_other (g cm-3)", "bdNRCS_prep_code")# SOC columns

FIA.df <- read_csv(file = FIADBDatafile,
                    col_types = cols(.default =col_character())) %>%
  select("CN", "STATECD", "COUNTYCD", "PLOT", "SMPLNNBR", "VSTNBR", "LAYER_TYPE", #ID columns
         "BULK_DENSITY") 
         #"COARSE_FRACTION_PCT", "C_ORG_PCT")

```

# Method 1

Assign everything in line via scripts and use the code as documentation.

```{r}

#Transform the data into a set of id-variable-value-unit-method 

FIA.dataStructure <- tribble(~'study_id', ~'table_id', ~'column_id', ~'is_type', ~of_variable,
  'FIADB_RMRS', 'Soils_Lab', 'BULK_DENSITY', 'value', 'Bulk_density'
)

FIA.dataDescription <- tribble(~'study_id', ~'table_id', ~'column_id', ~'is_type', ~'with_entry',
         'FIADB_RMRS', 'Soils_Lab',	'BULK_DENSITY', 'unit', 'g cm^-3',
'FIADB_RMRS','Soils_Lab', 'BULK_DENSITY', 'method','mass per volume of oven-dry soil inclusive of coarse fraction') %>%
  pivot_wider(names_from = is_type, values_from = with_entry)

valueCols <- FIA.dataStructure %>%
  filter(is_type == 'value')

data1.df <- FIA.df %>%
  mutate(study_id = 'FIADB_RMRS', table_id = 'Soils_Lab') %>%
  #pivot the values longer
  pivot_longer(cols = valueCols$column_id, names_to = 'column_id', 
               values_to = 'value', values_drop_na = TRUE) %>%
  left_join(FIA.dataDescription, by = join_by(study_id, table_id, column_id))
  

data2.df <- ISCN.df %>%
  pivot_longer(cols = c("bd_samp (g cm-3)", "bd_tot (g cm-3)", "bd_whole (g cm-3)", "bd_other (g cm-3)"),
               names_to = 'variable', 
               values_to = 'value', values_drop_na = TRUE) %>%
  mutate(unit = 'g cm^-3',
         metaDataMethod = case_when(variable == 'bd_samp (g cm-3)' ~ 'Fine earth bulk density',
                                    variable == "bd_tot (g cm-3)" ~ 'Whole soil bulk density',
                                    variable == 'bd_whole (g cm-3)' ~ 'Fine earth (estimated coarse fraction correction) bulk density',
                                    variable == "bd_other (g cm-3)" ~ 'method no specified',
                                    TRUE ~ 'bulk density method not recognized'))

data2.df$method <- paste0('bdNRCS_prep_code:', data2.df$bdNRCS_prep_code, "; ", 
                         'bd_method:', data2.df$bd_method,  "; ", 
                         'metadata_method:', data2.df$metaDataMethod)

data2.df <- data2.df %>%
  select(c("dataset_name_sub", "site_name", "profile_name", "layer_name", 'variable', 'value', 'method', 'unit'))

dataFull.df <- data1.df %>%
  bind_rows(data2.df)

```

# Method 2

Leveraging meta data annoations more generally to document tranformations.

```{r}

```

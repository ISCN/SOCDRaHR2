---
title: "FIA data merge"
author: "Kathe Todd-Brown, Ursa"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: yes
---

```{r setup, include=FALSE}
install.packages("sf")
install.packages("geojsonio")
install.packages("choroplethr")
install_github("ISCN/SOCDRaHR2")

library(devtools)
library(tidyverse)
library(dplyr)
library(readr)
library(googlesheets4)
library(SOCDRaH2)
library(sf)
library(geojsonio)
library(choroplethr)
library(maps)
library(tigris)
library(ggplot2)
library(plotly)
```

# International Soil Carbon Network (ISCN) Database 

```{r ISCN downloadData}

##Download ISCN and FIA tables (layer, profile, citation, dataset and Soils_Lab, Soils_Sample_Location)

#download from edi
ISCN_layer_old.df <- read_delim(file = "https://portal.edirepository.org/nis/dataviewer?packageid=edi.1160.1&entityid=4af719a84f8981fcc63f1f92760cb253",
                    col_types = cols(.default =col_character()),
                    delim = ';',
                    n_max = 1e6)

#download using read script to fix errors
ISCN.ls <- ISCN3_3(data_dir = '~/Documents/datasets/ISCN')

ISCN_layer.df <- ISCN.ls$layer
ISCN_profile.df <- ISCN.ls$profile

# #ISCN_profile.df <- read_delim(file = 'https://portal.edirepository.org/nis/dataviewer?packageid=edi.1160.1&entityid=40527580cc045d33d9a5aaf728bf204e',
#                     col_types = cols(.default =col_character()),
#                     delim = ';',
#                     n_max = 1e5)

ISCN_citation.df <- read_delim(file = 'https://portal.edirepository.org/nis/dataviewer?packageid=edi.1160.1&entityid=320e31ca911f187550ca2143c31fd408',
                    col_types = cols(.default =col_character()),
                    delim = ';',
                    n_max = 1e5)

ISCN_dataset.df <- read_delim(file = 'https://portal.edirepository.org/nis/dataviewer?packageid=edi.1160.1&entityid=cdd0c7a4cac3f28d6d788c91f506775f',
                    col_types = cols(.default =col_character()),
                    delim = ';',
                    n_max = 1e5)
```

```{r ISCN download data cont.}
#Concatenate citations for same datasets
ISCN_citation.df <- ISCN_citation.df %>% 
  group_by(dataset_name) %>% 
  mutate(citation = paste0(citation, collapse = "; ")) %>%
  distinct(dataset_name, .keep_all = TRUE)


#try to fix duplicate layer names in northern circumpolar dataset
ISCN3_layer.df <- ISCN_layer.df %>% mutate(layer_name = if_else(dataset_name_sub == "Northern Circumpolar Soil Carbon Database (NCSCD)" & grepl("^200", layer_name), paste(gsub("\\.\\d+$", "", layer_name), `layer_bot (cm)`, sep = "."), layer_name))

northern <- ISCN_layer.df$layer_name[ISCN_layer.df$dataset_name_sub == "Northern Circumpolar Soil Carbon Database (NCSCD)" & ISCN_layer.df$dataset_name_soc == "ISCN No SOC stock computation" & grepl("^200", ISCN_layer.df$layer_name)]

northern2 <- ISCN_layer.df$layer_name[ISCN_layer.df$dataset_name_sub == "Northern Circumpolar Soil Carbon Database (NCSCD)" & ISCN_layer.df$dataset_name_soc == "Northern Circumpolar Soil Carbon Database (NCSCD)" & grepl("^200", ISCN_layer.df$layer_name)]

#give each row a unique id if still duplicates
ISCN_layer.df <- ISCN_layer.df %>% 
  distinct() %>% 
  dplyr::mutate(observation_id = row_number())

```

```{r Fixing ISCN layer table}

#find duplicate samples in layer table
ISCN_layer.df <- ISCN_layer.df %>%
  group_by(dataset_name_sub, site_name, profile_name, layer_name, `layer_top (cm)`, `layer_bot (cm)`) %>%
  dplyr::mutate(id = cur_group_id()) %>%
  ungroup()

ISCN_duplicated.df <- ISCN_layer.df[duplicated(ISCN_layer.df$id), ]

all_duplicates <- ISCN_layer.df %>% filter(id %in% ISCN_duplicated.df$id)

unique(all_duplicates$dataset_name_sub)

NRCS_dup <- all_duplicates %>% subset(dataset_name_sub == 'NRCS Sept/2014')
worldwide_dup <- all_duplicates %>% subset(dataset_name_sub == 'Worldwide soil carbon and nitrogen data')
northern_dup <- all_duplicates %>% subset(dataset_name_sub == 'Northern Circumpolar Soil Carbon Database (NCSCD)')
UMBS_dup <- all_duplicates %>% subset(dataset_name_sub == 'UMBS_FASET') %>% distinct()

```

# #Create long table of each ISCN dataset

```{r ISCN Layer table}
#Create long table of each ISCN dataset

#retrieve ISCN annotations from datakeys sheet
ISCN_layer.dataAnnotation <- read_sheet("https://docs.google.com/spreadsheets/d/1mllMhm2V2kMv6KvPSnuXDEBWAS-2okWK2F4mXbSjphU/edit?usp=sharing", sheet = "dataAnnotation", range = "dataAnnotation!A:F") %>% filter(study_id == 'ISCN3') %>% filter(table_id == "layer")

ISCN_layer_long.df <- ISCN_layer.df %>%
  #convert all columns to characters
  dplyr::mutate(across(.cols = everything(), .fns = as.character)) %>%
  mutate(study_id = 'ISCN3', 
         table_id = 'layer')  %>%
  #Group by the columns that are identifiers
  group_by(across(all_of((ISCN_layer.dataAnnotation %>%
                           filter(is_type == 'identifier'))$column_id))) %>%
  #Pull the current group index or id 
  dplyr::mutate(observation_id = cur_group_id()) %>%
  #and then remove the grouping so we can move on
  ungroup() %>%
  pivot_longer(cols = -c(study_id, table_id, observation_id), names_to = 'column_id', 
               values_to = 'with_entry', values_drop_na = TRUE) %>%
  full_join(ISCN_layer.dataAnnotation, 
            by = join_by(study_id, table_id, column_id),
            suffix = c('.data', ''), multiple = 'all') %>%
  mutate(
    with_entry = if_else((with_entry == "--") | is.na(with_entry), with_entry.data, with_entry)) %>%
  select(-with_entry.data)
```

```{r ISCN Profile table}
#retrieve ISCN annotations from datakeys sheet
ISCN_profile.dataAnnotation <- read_sheet("https://docs.google.com/spreadsheets/d/1mllMhm2V2kMv6KvPSnuXDEBWAS-2okWK2F4mXbSjphU/edit?usp=sharing", sheet = "dataAnnotation", range = "dataAnnotation!A:F") %>% filter(study_id == 'ISCN3') %>% filter(table_id == "profile")

ISCN_profile.dataAnnotation <- ISCN_profile.dataAnnotation[-(6:8),]

ISCN_profile_long.df <- ISCN_profile.df %>%
  dplyr::mutate(across(.cols = everything(), .fns = as.character)) %>%
  mutate(study_id = 'ISCN3', 
         table_id = 'profile')  %>%
  #Group by the columns that are identifiers
  group_by(across(all_of((ISCN_profile.dataAnnotation %>%
                           filter(is_type == 'identifier'))$column_id))) %>%
  #Pull the current group index or id 
  dplyr::mutate(observation_id = cur_group_id()) %>%
  #and then remove the grouping so we can move on
  ungroup() %>%
  pivot_longer(cols = -c(study_id, table_id, observation_id), names_to = 'column_id', 
               values_to = 'with_entry', values_drop_na = TRUE) %>%
  full_join(ISCN_profile.dataAnnotation, 
            by = join_by(study_id, table_id, column_id),
            suffix = c('.data', ''), multiple = 'all') %>%
  mutate(
    with_entry = if_else((with_entry == "--") | is.na(with_entry), with_entry.data, with_entry)) %>%
  select(-with_entry.data)
```

```{r ISCN Citation table}
#retrieve ISCN annotations from datakeys sheet
ISCN_citation.dataAnnotation <- read_sheet("https://docs.google.com/spreadsheets/d/1mllMhm2V2kMv6KvPSnuXDEBWAS-2okWK2F4mXbSjphU/edit?usp=sharing", sheet = "dataAnnotation", range = "dataAnnotation!A:F") %>% 
  filter(study_id == 'ISCN3') %>% 
  filter(table_id == "citation")

ISCN_citation_long.df <- ISCN_citation.df %>%
  mutate(study_id = 'ISCN3', 
         table_id = 'citation')  %>%
  #Group by the columns that are identifiers
  group_by(across(all_of((ISCN_citation.dataAnnotation %>%
                           filter(is_type == 'identifier'))$column_id))) %>%
  #Pull the current group index or id 
  dplyr::mutate(observation_id = cur_group_id()) %>%
  #and then remove the grouping so we can move on
  ungroup() %>%
  pivot_longer(cols = -c(study_id, table_id, observation_id), names_to = 'column_id', 
               values_to = 'with_entry', values_drop_na = TRUE) %>%
  full_join(ISCN_citation.dataAnnotation, 
            by = join_by(study_id, table_id, column_id),
            suffix = c('.data', ''), multiple = 'all') %>%
  mutate(
    with_entry = if_else((with_entry == "--") | is.na(with_entry), with_entry.data, with_entry)) %>%
  select(-with_entry.data)
```

```{r ISCN Dataset table}
#retrieve ISCN annotations from datakeys sheet
ISCN_dataset.dataAnnotation <- read_sheet("https://docs.google.com/spreadsheets/d/1mllMhm2V2kMv6KvPSnuXDEBWAS-2okWK2F4mXbSjphU/edit?usp=sharing", sheet = "dataAnnotation", range = "dataAnnotation!A:F") %>% filter(study_id == 'ISCN3') %>% filter(table_id == "dataset")

ISCN_dataset_long.df <- ISCN_dataset.df %>%
  mutate(study_id = 'ISCN3', 
         table_id = 'dataset')  %>%
  #Group by the columns that are identifiers
  group_by(across(all_of((ISCN_dataset.dataAnnotation %>%
                           filter(is_type == 'identifier'))$column_id))) %>%
  #Pull the current group index or id 
  dplyr::mutate(observation_id = cur_group_id()) %>%
  #and then remove the grouping so we can move on
  ungroup() %>%
  pivot_longer(cols = -c(study_id, table_id, observation_id), names_to = 'column_id', 
               values_to = 'with_entry', values_drop_na = TRUE) %>%
  full_join(ISCN_dataset.dataAnnotation, 
            by = join_by(study_id, table_id, column_id),
            suffix = c('.data', ''), multiple = 'all') %>%
  mutate(
    with_entry = if_else((with_entry == "--") | is.na(with_entry), with_entry.data, with_entry)) %>%
  select(-with_entry.data)
   
```

# Forest Inventory Analysis Database (FIADB)

```{r FIA Data Download}
FIA_lab.df <- read_delim("~/Desktop/Datasets/ENTIRE_SOILS_LAB.csv", col_types = cols(.default =col_character()),
                    delim = ',',
                    n_max = 1e5)

FIA_loc.df <- read_delim("~/Desktop/Datasets/ENTIRE_SOILS_SAMPLE_LOC.csv", col_types = cols(.default =col_character()),
                    delim = ',',
                    n_max = 1e5)

FIA_visit.df <- read_delim("~/Desktop/Datasets/ENTIRE_SOILS_VISIT.csv", col_types = cols(.default =col_character()),
                    delim = ',',
                    n_max = 1e5)

FIA_erosion.df <- read_delim("~/Desktop/Datasets/ENTIRE_SOILS_EROSION.csv", col_types = cols(.default =col_character()),
                    delim = ',',
                    n_max = 1e5)

FIA_survey.df <- read_delim("~/Desktop/Datasets/ENTIRE_SURVEY.csv", col_types = cols(.default =col_character()),
                    delim = ',',
                    n_max = 1e5)

FIA_plot.df <- read_delim("~/Desktop/Datasets/ENTIRE_PLOT.csv", col_types = cols(.default =col_character()),
                    delim = ',',
                    n_max = 1e5)
# add ENTIRE_SURVEY.CSV and ENTIRE_PLOT.CSV from the fiadb
# documentation available on the user guide [provide page number and citation for future reference]
```




```{r FIA Soil labs}
#Create long table of each FIA dataset

#retrieve FIA annotations from datakeys sheet
FIA_lab.dataAnnotation <- read_sheet("https://docs.google.com/spreadsheets/d/1mllMhm2V2kMv6KvPSnuXDEBWAS-2okWK2F4mXbSjphU/edit?usp=sharing", sheet = "dataAnnotation", range = "dataAnnotation!A:F") %>% filter(study_id == 'FIADB_RMRS') %>% filter(table_id == "ENTIRE_SOILS_LAB")

# FIA soil lab dataset 
FIA_lab_long.df <- FIA_lab.df %>%
  mutate(study_id = 'FIADB_RMRS', 
         table_id = 'ENTIRE_SOILS_LAB')  %>%
  #Group by the columns that are identifiers
  group_by(across(all_of((FIA_lab.dataAnnotation %>%
                           filter(is_type == 'identifier'))$column_id))) %>%
  #Pull the current group index or id 
  dplyr::mutate(observation_id = cur_group_id()) %>%
  #and then remove the grouping so we can move on
  ungroup() %>%
  pivot_longer(cols = -c(study_id, table_id, observation_id), names_to = 'column_id', 
               values_to = 'with_entry', values_drop_na = TRUE) %>%
  full_join(FIA_lab.dataAnnotation, 
            by = join_by(study_id, table_id, column_id),
            suffix = c('.data', ''), multiple = 'all') %>%
  mutate(
    with_entry = if_else((with_entry == "--") | is.na(with_entry), with_entry.data, with_entry)) %>%
  select(-with_entry.data)
```

```{r FIA Soil Locations}
# Annotations for FIA soil location and soil information 
FIA_loc.dataAnnotation <- read_sheet("https://docs.google.com/spreadsheets/d/1mllMhm2V2kMv6KvPSnuXDEBWAS-2okWK2F4mXbSjphU/edit?usp=sharing", sheet = "dataAnnotation", range = "dataAnnotation!A:F") %>% filter(study_id == 'FIADB_RMRS') %>% filter(table_id == "ENTIRE_SOILS_SAMPLE_LOC")

#Creating a long data table for the location table 
FIA_loc_long.df <- FIA_loc.df %>%
  #add the study and table id manually
  mutate(study_id = 'FIADB_RMRS', 
         table_id = 'ENTIRE_SOILS_SAMPLE_LOC') %>%
  #Group by the columns that are identifiers
  group_by(across(all_of((FIA_loc.dataAnnotation %>%
                           filter(is_type == 'identifier'))$column_id))) %>%
  #Pull the current group index or id 
  dplyr::mutate(observation_id = cur_group_id()) %>%
  #and then remove the grouping so we can move on
  ungroup() %>%
  #shoe string the data
  pivot_longer(cols = -c(study_id, table_id, observation_id),
               names_to = 'column_id', 
               values_to = 'with_entry',
               values_drop_na = TRUE) %>%
  #annotate so that we can also have the 'meta' data
  full_join(FIA_loc.dataAnnotation, 
            by = join_by(study_id, table_id, column_id),
            suffix = c('.data', ''),
            multiple = 'all') %>%
  #deal with entries from both the meta and data tables
  mutate(
    with_entry = if_else((with_entry == "--") | is.na(with_entry), with_entry.data, with_entry)) %>%
  select(-with_entry.data)
```

```{r checking BD & C values in FIADB}
BD_high <- FIA_lab.df %>% 
  filter(BULK_DENSITY > 2.75) #& LAYER_TYPE == 'FF_TOTAL'

BD_whole <- FIA_lab.df %>% 
  filter(!is.na(BULK_DENSITY)) %>% 
  dplyr::mutate(BULK_DENSITY = as.numeric(BULK_DENSITY))

BD_optimum <-FIA_lab.df %>% 
  filter(BULK_DENSITY < 2.75) %>% 
  dplyr::mutate(BULK_DENSITY = as.numeric(BULK_DENSITY))

BD_forest_floor <- BD_optimum %>% #this is litter layer + duff (humus) layer
  filter(!is.na(BULK_DENSITY), LAYER_TYPE == 'FF_TOTAL' ) %>% 
  dplyr::mutate(BULK_DENSITY = as.numeric(BULK_DENSITY), C_ORG_PCT = as.numeric(C_ORG_PCT))

BD_litter_layer <- FIA_lab.df %>% # this is the fresh litter layer; less decomposed
  filter(!is.na(BULK_DENSITY), LAYER_TYPE == 'L_ORG' ) %>% 
  dplyr::mutate(BULK_DENSITY = as.numeric(BULK_DENSITY))

BD_organic_soil_10 <- FIA_lab.df %>% 
  filter(!is.na(BULK_DENSITY), LAYER_TYPE == 'ORG_1' ) %>% 
  dplyr::mutate(BULK_DENSITY = as.numeric(BULK_DENSITY)) 

BD_organic_soil_20 <- FIA_lab.df %>% 
  filter(!is.na(BULK_DENSITY), LAYER_TYPE == 'ORG_2' ) %>% 
  dplyr::mutate(BULK_DENSITY = as.numeric(BULK_DENSITY))

BD_mineral_soil_10 <- FIA_lab.df %>% 
  filter(!is.na(BULK_DENSITY), LAYER_TYPE == 'MIN_1' ) %>% 
  dplyr::mutate(BULK_DENSITY = as.numeric(BULK_DENSITY)) 

BD_mineral_soil_20 <- FIA_lab.df %>% 
  filter(!is.na(BULK_DENSITY), LAYER_TYPE == 'MIN_2' ) %>% 
  dplyr::mutate(BULK_DENSITY = as.numeric(BULK_DENSITY), C_ORG_PCT = as.numeric(C_ORG_PCT))

ggplot(BD_forest_floor) +
  geom_point(aes(x = BULK_DENSITY, y = C_ORG_PCT))

FIA_lab.df$BULK_DENSITY <- as.numeric(FIA_lab.df$BULK_DENSITY)
FIA_lab.df$C_ORG_PCT <- as.numeric(FIA_lab.df$C_ORG_PCT)

ggplot(FIA_lab.df %>% 
  filter(BULK_DENSITY < 4, LAYER_TYPE == 'FF_TOTAL')) +
  geom_point(aes(x = BULK_DENSITY, y = C_ORG_PCT))


```


```{r FIPS Maps}
?county.fips
?map.data

states_US <- map_data("state")
county_US <- map_data("county")

# do not use this as fips.codes does not contain all US territories 
data("county.fips")
data("state.fips")
# fips.codes <- county.fips %>%
#   # create two new variables, splitting "polyname" on the comma
#   separate(polyname, c("region", "subregion"), ",")
# 
# join_county_fips <- left_join(county_US, fips.codes, by=c("region","subregion")) %>%
#   #select(region,subregion) %>%
#   group_by(region,subregion) #%>%
#   #dplyr::summarise(n())

# use this instead!

# fips_codes <- county.fips %>%
#   # create two new variables, splitting "polyname" on the comma
#   separate(polyname, c("region", "subregion"), ",")

data("fips_codes")
fips_codes <- fips_codes %>% 
  mutate(STATECD = state_code, COUNTYCD = county_code) %>% 
  select(-state_code) %>% 
  select(-county_code)

grouping_counties <- FIA_lab.df %>% 
  dplyr::select(PLT_CN, STATECD, COUNTYCD) %>% 
  #dplyr::group_by(STATECD) %>% 
  unique() %>% 
  dplyr::reframe(plot_count = n(), .by = c(STATECD, COUNTYCD))
# plot it on a log scale 

merge_fips_data <- left_join(grouping_counties, fips_codes, by=c("STATECD", "COUNTYCD"))  

temp <- grouping_counties %>% 
  #distinct(STATECD) %>% 
  mutate(STATECD = sprintf('%02s', STATECD),
         COUNTYCD = sprintf('%03s', COUNTYCD))
  
merge_fips_data2 <- left_join(temp, fips_codes, by=c("STATECD", "COUNTYCD"))  

usa_state_shapefile <- st_read("~/Downloads/tl_2022_us_state/tl_2022_us_state.shp") %>% 
  mutate(STATECD = STATEFP) %>% 
  select(-STATEFP)

usa_county_shapefile <- st_read("~/Downloads/tl_2022_us_county/tl_2022_us_county.shp") %>% 
  mutate(STATECD = STATEFP,
         COUNTYCD = COUNTYFP) %>% 
  select(-STATEFP) %>% 
  select(-COUNTYFP)


# Download cb_2022_us_county_5m.zip under "County" from
# https://www.census.gov/geographies/mapping-files/time-series/geo/cartographic-boundary.html
us_counties <- read_sf("~/Downloads/maps/cb_2022_us_county_5m/cb_2022_us_county_5m.shp")%>% 
  mutate(STATECD = STATEFP,
         COUNTYCD = COUNTYFP) %>% 
  select(-STATEFP) %>% 
  select(-COUNTYFP)
st_crs(us_counties)

merge_shapefile2 <- merge_shapefile 
attr(merge_shapefile2, "sf_column") <- "geometry" # names and attr

usamap <- map_data('usa')
ggplot(usamap) +
  geom_polygon( aes(x=long, y = lat, group=group), fill = 'white') +
  #borders(usamap, fill = "black") +
  geom_sf(merge_shapefile2, mapping = aes(geometry = geometry, fill = plot_count)) +
  scale_fill_gradient(trans = 'log10', low = "orange", high = "blue") +
  scale_fill_viridis_c(trans = 'log10') +
  labs(x = "Latitude (in decimal degress)",
       y = "Longitude (in decimal degrees)",
       #title = "Map of the United States",
       title = "FIA Data spread across the counties of the US",
       subtitle = "County regions showing number of plot samples")

ggplot(merge_shapefile2) +
  geom_sf(mapping = aes(geometry = geometry, fill = plot_count))  +
  scale_fill_gradient(trans = 'log10') +
  scale_fill_viridis_b()

shapefile <- st_read("~/Downloads/maps/cb_2022_us_county_5m/cb_2022_us_county_5m.shp")
str(shapefile)
head(shapefile)
summary(shapefile)
st_crs(shapefile)

ggplot(shapefile) +
  geom_sf()

merge_shapefile <- left_join(temp, us_counties, by = join_by("COUNTYCD", "STATECD"))
# do a normal merge not the tidyverse one
# FIPS 5 digit
# merging shape files with dataframe in r?
# averages? medians?

subset_merge <- merge_shapefile %>% 
  filter(LAYER_TYPE != 'FF_TOTAL') %>%   # removing FF_TOTAL
  group_by(LAYER_TYPE, STATECD, COUNTYCD, BULK_DENSITY) %>% 
  summarise()

new_merge <- merge(temp, us_counties, by.x = c("COUNTYCD", "STATECD"), by.y = c("COUNTYCD", "STATECD"))
plot(new_merge)

ggplot()+
  geom_sf(subset_merge, mapping = aes(fill = C_ORG_PCT))

ggplot() +
  geom_sf(data = merge_shapefile, aes(fill = C_ORG_PCT))

plot(merge_shapefile["geometry"], col = merge_shapefile$C_ORG_PCT)

```


```{r FIA survey}

# Annotations for FIA survey table 
FIA_survey.dataAnnotation <- read_sheet("https://docs.google.com/spreadsheets/d/1mllMhm2V2kMv6KvPSnuXDEBWAS-2okWK2F4mXbSjphU/edit?usp=sharing", sheet = "dataAnnotation", range = "dataAnnotation!A:F") %>% filter(study_id == 'FIADB_RMRS') %>% filter(table_id == "ENTIRE_SURVEY")

#Creating a long data table for the survey table 
FIA_survey_long.df <- FIA_survey.df %>%
  #add the study and table id manually
  mutate(study_id = 'FIADB_RMRS', 
         table_id = 'ENTIRE_SURVEY') %>%
  #Group by the columns that are identifiers
  group_by(across(all_of((FIA_survey.dataAnnotation %>%
                           filter(is_type == 'identifier'))$column_id))) %>%
  #Pull the current group index or id 
  dplyr::mutate(observation_id = cur_group_id()) %>%
  #and then remove the grouping so we can move on
  ungroup() %>%
  #shoe string the data
  pivot_longer(cols = -c(study_id, table_id, observation_id),
               names_to = 'column_id', 
               values_to = 'with_entry',
               values_drop_na = TRUE) %>%
  #annotate so that we can also have the 'meta' data
  full_join(FIA_survey.dataAnnotation, 
            by = join_by(study_id, table_id, column_id),
            suffix = c('.data', ''),
            multiple = 'all') %>%
  #deal with entries from both the meta and data tables
  mutate(
    with_entry = if_else((with_entry == "--") | is.na(with_entry), with_entry.data, with_entry)) %>%
  select(-with_entry.data)

```

```{r FIA plot dataset}
# Annotations for FIA plot table 
FIA_plot.dataAnnotation <- read_sheet("https://docs.google.com/spreadsheets/d/1mllMhm2V2kMv6KvPSnuXDEBWAS-2okWK2F4mXbSjphU/edit?usp=sharing", sheet = "dataAnnotation", range = "dataAnnotation!A:F") %>% filter(study_id == 'FIADB_RMRS') %>% filter(table_id == "ENTIRE_PLOT")

#Creating a long data table for the location table 
FIA_plot_long.df <- FIA_plot.df %>%
  #add the study and table id manually
  mutate(study_id = 'FIADB_RMRS', 
         table_id = 'ENTIRE_PLOT') %>%
  #Group by the columns that are identifiers
  group_by(across(all_of((FIA_plot.dataAnnotation %>%
                           filter(is_type == 'identifier'))$column_id))) %>%
  #Pull the current group index or id 
  dplyr::mutate(observation_id = cur_group_id()) %>%
  #and then remove the grouping so we can move on
  ungroup() %>%
  #shoe string the data
  pivot_longer(cols = -c(study_id, table_id, observation_id),
               names_to = 'column_id', 
               values_to = 'with_entry',
               values_drop_na = TRUE) %>%
  #annotate so that we can also have the 'meta' data
  full_join(FIA_plot.dataAnnotation, 
            by = join_by(study_id, table_id, column_id),
            suffix = c('.data', ''),
            multiple = 'all') %>%
  #deal with entries from both the meta and data tables
  mutate(
    with_entry = if_else((with_entry == "--") | is.na(with_entry), with_entry.data, with_entry)) %>%
  select(-with_entry.data)
```

# Pulling things together

```{r}
#Bind all long tables together

bigData <- FIA_loc_long.df %>%
  select(study_id, table_id, observation_id, of_variable, is_type, with_entry) %>%
  bind_rows(FIA_lab_long.df %>%
              select(study_id, table_id, observation_id, of_variable, is_type, with_entry)) %>%
  # #bind_rows(FIA_survey_long.df %>%
  #             select(study_id, table_id, observation_id, of_variable, is_type, with_entry)) %>% 
  # #bind_rows(FIA_plot_long.df%>%
  #             select(study_id, table_id, observation_id, of_variable, is_type, with_entry)) %>% 
  bind_rows(ISCN_layer_long.df %>%
              select(study_id, table_id, observation_id, of_variable, is_type, with_entry)) %>%
  bind_rows(ISCN_profile_long.df %>%
              select(study_id, table_id, observation_id, of_variable, is_type, with_entry)) %>%
  bind_rows(ISCN_citation_long.df %>%
              select(study_id, table_id, observation_id, of_variable, is_type, with_entry)) %>%
  bind_rows(ISCN_dataset_long.df %>%
              select(study_id, table_id, observation_id, of_variable, is_type, with_entry)) #%>%
  #unique() #remove duplicates from repeated methods applying to multiple columns
```

# Annotations harmonization

```{r}
#retrieve variable map
variableMap <- read_sheet("https://docs.google.com/spreadsheets/d/1mllMhm2V2kMv6KvPSnuXDEBWAS-2okWK2F4mXbSjphU/edit?usp=sharing", sheet = "variableMap", range = "variableMap!A:D")

#rename variables based on map
newData.df <- bigData %>%
  left_join(variableMap, by = join_by(study_id, table_id, of_variable)) %>%
  select(-of_variable) %>%
  mutate(of_variable = ISCN3_target_variable)

#remove entries with no variable specified
newData.df <- newData.df[!grepl('--|NA', newData.df$of_variable),]

#newData.df <- newData.df[!duplicated(newData.df[ , c("study_id","table_id", "observation_id", "is_type", "of_variable")]),]
  
```

# Plot it

```{r}
#pivot out data
data_wide_values.df <- newData.df %>%
  filter(is_type %in% c('value', 'identifier')) %>%
  select(-is_type) %>%
  pivot_wider(names_from=of_variable, 
              values_from=with_entry,
              values_fn = function(xx) {return(xx[1])}) #hack to make pivot work

data_wide_values.df <- data_wide_values.df %>%
  mutate(across(.cols = starts_with('bulk_density'), as.numeric))

ggplot(data_wide_values.df) +
  geom_histogram(aes(x=bulk_density_whole_soil)) +
  facet_wrap(~study_id, scales='free_y') +
  scale_x_log10() +
  scale_y_log10()
ggplot(data_wide_values.df %>%
         pivot_longer(cols = c(bulk_density_whole_soil, bulk_density_fine_earth, bulk_density_unknown))) +
  geom_histogram(aes(x=value, fill = study_id)) +
  facet_grid(study_id~name, scales = 'free_y') +
  scale_x_log10() +
  scale_y_log10()

```


#Test comparing raw data to combined by plots (organic carbon)
```{r}
data_wide_values.df <- data_wide_values.df %>%
  mutate(across(.cols = starts_with('organic_carbon'), as.numeric))

ggplot(data_wide_values.df) +
  geom_histogram(aes(x=organic_carbon, fill = study_id)) +
  facet_wrap(~study_id, scales='free_y') #+
  #scale_x_log10() +
  #scale_y_log10()


ISCN_layer.df <- ISCN_layer.df %>% mutate(`oc (percent)` = as.numeric(`oc (percent)`))

ggplot(ISCN_layer.df) +
  geom_histogram(aes(x=`oc (percent)`), fill = "#00BFC4") #+
  #facet_wrap(scales='free_y') +
  #scale_x_log10() +
  #scale_y_log10()

FIA_lab.df <- FIA_lab.df %>% mutate(C_ORG_PCT = as.numeric(C_ORG_PCT))

ggplot(FIA_lab.df) +
  geom_histogram(aes(x=C_ORG_PCT), fill = "#F8766D") #+
  #facet_wrap(scales='free_y') +
  #scale_x_log10() +
  #scale_y_log10()


```

#Tests comparing raw data to combined by exact values (organic carbon in layer and soil lab)
```{r}
data_wide_values.df <- data_wide_values.df %>%
  mutate(across(.cols = starts_with('organic_carbon'), as.numeric))

organic_carbon_ISCN <- ISCN_layer.df$`oc (percent)`

organic_carbon_ISCN_merged <- data_wide_values.df %>% filter(table_id == "layer") %>% filter(row_number() <= n()-1)

organic_carbon_ISCN_merged <- organic_carbon_ISCN_merged$organic_carbon

identical(organic_carbon_ISCN, organic_carbon_ISCN_merged)



organic_carbon_FIA <- FIA_lab.df$C_ORG_PCT

organic_carbon_FIA <- as.numeric(organic_carbon_FIA)

organic_carbon_FIA <- organic_carbon_FIA[!is.na(organic_carbon_FIA)]

organic_carbon_FIA_merged <- data_wide_values.df %>% filter(table_id == "Soils_Lab")

organic_carbon_FIA_merged <- organic_carbon_FIA_merged$organic_carbon

organic_carbon_FIA_merged <- organic_carbon_FIA_merged[!is.na(organic_carbon_FIA_merged)]

identical(organic_carbon_FIA, organic_carbon_FIA_merged)

```
#Tests comparing raw data to combined by exact values (profile, citation, dataset)
```{r}
data_wide_values.df %>% 
  drop_na(-c("study_id", "table_id"))

landform_ISCN <- ISCN_profile.df$`landform (landform)`

landform_ISCN_merged <- data_wide_values.df %>% filter(table_id == "profile") %>% filter(row_number() <= n()-1)

landform_ISCN_merged <- landform_ISCN_merged$landform

identical(landform_ISCN, landform_ISCN_merged)



citation_ISCN <- ISCN_citation.df$citation

citation_ISCN_merged <- data_wide_values.df %>% filter(table_id == "citation")

citation_ISCN_merged <- citation_ISCN_merged$citation

identical(citation_ISCN, citation_ISCN_merged)



curator_name_ISCN <- ISCN_dataset.df$curator_name

curator_name_ISCN_merged <- data_wide_values.df %>% filter(table_id == "dataset")

curator_name_ISCN_merged <- curator_name_ISCN_merged$curator_name

identical(curator_name_ISCN, curator_name_ISCN_merged)

```
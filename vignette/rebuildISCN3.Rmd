---
title: "ISCN take 3"
output: html_document
---




```{r setup}
library(SOCDRaH2)
library(tidyverse)
library(knitr)
library(ggplot2)
library(ggmap)
library(kableExtra)
dataDir <- '~/Documents/Datasets/ISCN'

#knitr::opts_chunk$set(eval=TRUE)
```

```{r load}
ISCN3.ls <- ISCN3_3(data_dir = dataDir) #this will throw an NA coercion warning that you can ignore
```

```{r summarys}
profile_summary <- ISCN3.ls$profile %>%
  select(dataset_name_sub, site_name) %>%
  unique()%>%
  group_by(dataset_name_sub) %>% 
  tally(name = 'profile_site_count')

layer_summary <- ISCN3.ls$layer %>%
  select(dataset_name_sub, site_name) %>%
  unique()%>%
  group_by(dataset_name_sub) %>% 
  tally(name = 'layer_site_count')

table_summary <- ISCN3.ls$study %>% 
  select(dataset_name, `dataset_type (dataset_type)`, dataset_description) %>%
  unique() %>%
  right_join(profile_summary %>%
              full_join(layer_summary, by = 'dataset_name_sub'), by=c('dataset_name' = 'dataset_name_sub'))

knitr::kable(table_summary %>%
    arrange(layer_site_count), 
  caption = 'Site counts for each contributing dataset submision (dataname_sub) in the profile and layer data table.')%>%
  kableExtra::kable_styling()
```

# Data Contributions

## University of Michigan Biological Station Forest Accelerated Succession ExperimenT (`UMBS_FASET`)

The University of Michigan Biological Station Forest Accelerated Succession Experiment (`UMBS_FASET`) data set is uncited and unpublished.

```{r}
study <- ISCN3.ls$study %>% 
  filter(dataset_name == "UMBS_FASET") %>%
  select(where(~any(!is.na(.)))) %>%
  t()

profile <- ISCN3.ls$profile %>%
  filter(dataset_name_sub == "UMBS_FASET")%>%
  select(where(~any(!is.na(.))))

layer <- ISCN3.ls$layer %>%
  filter(dataset_name_sub == "UMBS_FASET") %>%
  select(where(~any(!is.na(.))))

locations <- profile %>% 
  select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`) %>%
  bind_rows(layer %>%
              select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`)) %>%
  unique() %>%
  filter(is.finite(`lat (dec. deg)` + `long (dec. deg)`))

#Check to see if there is different/new information in the layer table that is not in the profile
#profile_info_layer <- layer %>%
#  select(any_of(setdiff(names(profile), c("layer_top (cm)", "layer_bot (cm)", "soc (g cm-2)")))) %>%
#  unique()
#
#series <- profile_info_layer %>% 
#  select(profile_name, soil_taxon, soil_series) %>% 
#  unique() %>%
#  anti_join(profile)
```

```{r}
knitr::kable(study,
  caption = 'Citations for the UMBS_FASET data set.') %>%
  kable_styling()
```

This data set is located in the United States and has 405 layer level observations and 137 profile-level observations of 1 unique latitude-longitude location.

```{r}
knitr::kable(summary(layer %>% select_if(is.factor)))
```

```{r}
knitr::kable(summary(profile %>% select_if(is.factor)))
```

```{r}
ggplot(locations) +
  geom_polygon(data = map_data('world'), aes(x=long, y = lat, group = group)) +
  geom_point(aes(x=`long (dec. deg)`, y = `lat (dec. deg)`), color = 'red', size = 3) +
  theme(axis.title = element_blank())

#remove data from the layer that appears in the profile that is not the top/bottom/soc
#select all numerical data, pivot and histogram
#select all factor data and tally
```

### Figures
```{r}

ggplot(data = layer %>%
         pivot_longer(cols = where(is.numeric) & 
                      !starts_with('layer') &
                      !ends_with('(dec. deg)'),
                      values_to = 'measurements', names_to = 'variable') %>%
         pivot_longer(cols = c('layer_top (cm)', 'layer_bot (cm)'), values_to = 'depth', names_to = 'layer_variable')) +
  geom_line(aes(x = depth, y = measurements,
                 group = paste(dataset_name_sub, site_name, profile_name))) +
  #coord_flip() +
  facet_wrap(~variable, scales = 'free')

ggplot(data = layer %>%
         pivot_longer(cols = where(is.numeric) &
                        !ends_with('(dec. deg)'),
                      values_to = 'measurements', names_to = 'variable')) +
  geom_histogram(aes(x = measurements)) +
  #coord_flip() +
  facet_wrap(~variable, scales = 'free')
```

### Fixed issues

Below is a list of known issues that were addressed between ISCN 3 and ISCN 3.3

  + The UMBS FASET is located in the United States and has 405 layer level observations and 137 profile-level observations of 1 unique latitude-longitude location.
  + `ISCN SOC computation` soil organic carbon calculations were removed and duplicate rows deleted.
  + Values in the `hzn` column of the `layer` table were reassigned to an NA character from "?", a nonspecific character.
  + Values in  `country (country)` column were reassigned to "United States" in the `layer` and `profile` tables because it was the known location of the collection state.
  
### Future issues
  + Citation practices were initially incompatible with CC-BY license for ISCN3; contacting data providers about modifying release for ISCN4
  + Check and see if data is still being collected at this research site. Data is unpublished, and references "100 yrs of research." Revisit in ISCN 4.

## Lu_LTER(`Lu_LTER`)

Please see @Ping2000, @Ping2002, @Ping2004, @Ping2005, and @Michaelson1996 for additional details and if you are using ISCN3 please cite.

```{r}
study <- ISCN3.ls$study %>% 
  filter(dataset_name == "Lu_LTER") %>%
  select(where(~any(!is.na(.)))) %>%
  t()

profile <- ISCN3.ls$profile %>%
  filter(dataset_name_sub == "Lu_LTER")%>%
  select(where(~any(!is.na(.))))

layer <- ISCN3.ls$layer %>%
  filter(dataset_name_sub == "Lu_LTER") %>%
  select(where(~any(!is.na(.))))

locations <- profile %>% 
  select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`) %>%
  bind_rows(layer %>%
              select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`)) %>%
  unique() %>%
  filter(is.finite(`lat (dec. deg)` + `long (dec. deg)`))

#Check to see if there is different/new information in the layer table that is not in the profile
#profile_info_layer <- layer %>%
#  select(any_of(setdiff(names(profile), c("layer_top (cm)", "layer_bot (cm)", "soc (g cm-2)")))) %>%
#  unique()
#
#series <- profile_info_layer %>% 
#  select(profile_name, soil_taxon, soil_series) %>% 
#  unique() %>%
#  anti_join(profile)
```

```{r}
knitr::kable(study,
  caption = 'Citations for the Lu_LTER data set.') %>%
  kable_styling()
```

This data set is located in the United States and has `r nrow(layer)` layer level observations and `r nrow(profile)` profile-level observations of `r nrow(locations)` unique latitude-longitude location.

```{r}
knitr::kable(summary(layer %>% select_if(is.factor)))
```

```{r}
knitr::kable(summary(profile %>% select_if(is.factor)))
```

```{r}
ggplot(locations) +
  geom_polygon(data = map_data('world'), aes(x=long, y = lat, group = group)) +
  geom_point(aes(x=`long (dec. deg)`, y = `lat (dec. deg)`), color = 'red', size = 3) +
  theme(axis.title = element_blank())

#remove data from the layer that appears in the profile that is not the top/bottom/soc
#select all numerical data, pivot and histogram
#select all factor data and tally
```

### Figures
```{r}

ggplot(data = layer %>%
         pivot_longer(cols = where(is.numeric) & 
                      !starts_with('layer') &
                      !ends_with('(dec. deg)'),
                      values_to = 'measurements', names_to = 'variable') %>%
         pivot_longer(cols = c('layer_top (cm)', 'layer_bot (cm)'), values_to = 'depth', names_to = 'layer_variable')) +
  geom_line(aes(x = depth, y = measurements,
                 group = paste(dataset_name_sub, site_name, profile_name))) +
  #coord_flip() +
  facet_wrap(~variable, scales = 'free')

ggplot(data = layer %>%
         pivot_longer(cols = where(is.numeric) &
                        !ends_with('(dec. deg)'),
                      values_to = 'measurements', names_to = 'variable')) +
  geom_histogram(aes(x = measurements)) +
  #coord_flip() +
  facet_wrap(~variable, scales = 'free')
```

### Fixed issues

In profile, the ISCN SOC to 1m computation rows were removed, getting rid of duplicate data. Nonrelevant columns were removed from layer and profile and missing values were filled in. This dataset was set in Alaska, so the Alaska Location code from the Template was used instead of the generic.

### Future issues

X Rename header and file name to reflect dataset_name
X Pull citation and add it to the bib file, check that citation matches the acknowledgment for study
X Check that the clean profile is correct given the original information
X Check that the clean layer is correct given the original information
X Check that maps are reasonable for the location
X Summarize what the modifications were for this particular dataset
X Create an issue on github with the template below
X Commit and link the commit to the issue

## Lu_PIMA

Please see @Ping2010 for additional details and if you are using ISCN3 please cite.

```{r}
study <- ISCN3.ls$study %>% 
  filter(dataset_name == "Lu_PIMA") %>%
  select(where(~any(!is.na(.)))) %>%
  t()

profile <- ISCN3.ls$profile %>%
  filter(dataset_name_sub == "Lu_PIMA")%>%
  select(where(~any(!is.na(.))))

layer <- ISCN3.ls$layer %>%
  filter(dataset_name_sub == "Lu_PIMA") %>%
  select(where(~any(!is.na(.))))

locations <- profile %>% 
  select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`) %>%
  bind_rows(layer %>%
              select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`)) %>%
  unique() %>%
  filter(is.finite(`lat (dec. deg)` + `long (dec. deg)`))

#Check to see if there is different/new information in the layer table that is not in the profile
#profile_info_layer <- layer %>%
#  select(any_of(setdiff(names(profile), c("layer_top (cm)", "layer_bot (cm)", "soc (g cm-2)")))) %>%
#  unique()
#
#series <- profile_info_layer %>% 
#  select(profile_name, soil_taxon, soil_series) %>% 
#  unique() %>%
#  anti_join(profile)
```

```{r}
knitr::kable(study,
  caption = 'Citations for the Lu_PIMA data set.') %>%
  kable_styling()
```

The `Lu_PIMA` data set in ISCN3 contains `r nrow(dataset_layer)` layer-level information and `r nrow(dataset_profile)` profile-level information after cleaning for ISCN3.5.

```{r}
knitr::kable(summary(layer %>% select_if(is.factor)))
```

```{r}
knitr::kable(summary(profile %>% select_if(is.factor)))
```

```{r}
ggplot(locations) +
  geom_polygon(data = map_data('world'), aes(x=long, y = lat, group = group)) +
  geom_point(aes(x=`long (dec. deg)`, y = `lat (dec. deg)`), color = 'red', size = 3) +
  theme(axis.title = element_blank())

#remove data from the layer that appears in the profile that is not the top/bottom/soc
#select all numerical data, pivot and histogram
#select all factor data and tally
```

### Figures
```{r}
ggplot(data = layer %>%
         pivot_longer(cols = where(is.numeric) & 
                      !starts_with('layer') &
                      !ends_with('(dec. deg)'),
                      values_to = 'measurements', names_to = 'variable') %>%
         pivot_longer(cols = c('layer_top (cm)', 'layer_bot (cm)'), values_to = 'depth', names_to = 'layer_variable')) +
  geom_line(aes(x = depth, y = measurements,
                 group = paste(dataset_name_sub, site_name, profile_name))) +
  #coord_flip() +
  facet_wrap(~variable, scales = 'free')

ggplot(data = layer %>%
         pivot_longer(cols = where(is.numeric) &
                        !ends_with('(dec. deg)'),
                      values_to = 'measurements', names_to = 'variable')) +
  geom_histogram(aes(x = measurements)) +
  #coord_flip() +
  facet_wrap(~variable, scales = 'free')
```
### Fixed Issues

The `Lu_PIMA` data set in ISCN3 contains `r nrow(dataset_layer)` layer-level information and `r nrow(dataset_profile)` profile-level information after cleaning for ISCN3.5.
Soil carbon columns were all calculated by ISCN3, thus these columns were removed in ISCN3.5 but no other manipulation was required.

### Future Issues


## Schuur

Please see @Schuur2007 for additional details and if you are using ISCN3 please cite.

```{r}
study <- ISCN3.ls$study %>% 
  filter(dataset_name == "Schuur") %>%
  select(where(~any(!is.na(.)))) %>%
  t()

profile <- ISCN3.ls$profile %>%
  filter(dataset_name_sub == "Schuur")%>%
  select(where(~any(!is.na(.))))

layer <- ISCN3.ls$layer %>%
  filter(dataset_name_sub == "Schuur") %>%
  select(where(~any(!is.na(.))))

locations <- profile %>% 
  select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`) %>%
  bind_rows(layer %>%
              select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`)) %>%
  unique() %>%
  filter(is.finite(`lat (dec. deg)` + `long (dec. deg)`))

#Check to see if there is different/new information in the layer table that is not in the profile
#profile_info_layer <- layer %>%
#  select(any_of(setdiff(names(profile), c("layer_top (cm)", "layer_bot (cm)", "soc (g cm-2)")))) %>%
#  unique()
#
#series <- profile_info_layer %>% 
#  select(profile_name, soil_taxon, soil_series) %>% 
#  unique() %>%
#  anti_join(profile)
```

```{r}
knitr::kable(study,
  caption = 'Citations for the Schuur data set.') %>%
  kable_styling()
```

The `Schuur` data set in ISCN3 contains `r nrow(dataset_layer)` layer-level information and `r nrow(dataset_profile)` profile-level information after cleaning for ISCN3.5.

```{r}
knitr::kable(summary(layer %>% select_if(is.factor)))
```

```{r}
knitr::kable(summary(profile %>% select_if(is.factor)))
```

```{r}
ggplot(locations) +
  geom_polygon(data = map_data('world'), aes(x=long, y = lat, group = group)) +
  geom_point(aes(x=`long (dec. deg)`, y = `lat (dec. deg)`), color = 'red', size = 3) +
  theme(axis.title = element_blank())

#remove data from the layer that appears in the profile that is not the top/bottom/soc
#select all numerical data, pivot and histogram
#select all factor data and tally
```

### Figures
```{r}
ggplot(data = layer %>%
         pivot_longer(cols = where(is.numeric) & 
                        !starts_with('layer') &
                        !ends_with('(dec. deg)'),
                      values_to = 'measurements' , names_to = 'variable') %>%
         pivot_longer(cols=c('layer_top (cm)',
                             'layer_bot (cm)'),
                      values_to='depth', names_to = 'layer_variable')) +
  geom_line(aes(x = depth, y = measurements,
                 group = paste(dataset_name_sub, site_name, profile_name))) +
  #coord_flip() +
  facet_wrap(~variable,scales = 'free')

ggplot(data = layer %>%
         pivot_longer(cols = where(is.numeric) &
                        !ends_with('(dec. deg)'),
                      values_to = 'measurements' , names_to = 'variable')) +
  geom_histogram(aes(x = measurements)) +
  #coord_flip() +
  facet_wrap(~variable, scales = 'free')
```

### Fixed Issues

In this section, we will pull out "Schuur" from ISCN 3 and clean it.
The ggplot maps were readjusted to accurately show the datapoints and center around Alaska.
The dataset_layer tables were adjusted to reassign the value "NA" to a column with "?".
The clean layer and clean profile table were checked for accuracy of information.
A citation was added to the bibliography file.
Four columns were removed from the original dataset that remove the soc columns from both the dataset_layer table and dataset_profile table.

### Future Issues

- [ ] Cite a database referenced in the dataset_study table
      The url links provided lead to a 404 error page.
        The correct url for dataone: https://search.dataone.org/view/knb-lter-bnz.366.16
        The datasite download link provided: http://www.lter.uaf.edu/404.php
          This link leads to a 404 error, contacting the researchers is necessary.

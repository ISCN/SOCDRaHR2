---
title: "ISCN3 Rebuild"
author: "Kathe Todd-Brown, Ursa"
date: "3/17/2022"
output: 
  html_document: 
    toc: yes
---

#knitr::opts_chunk$set(eval=TRUE)

Purpose: *This vignette describes the ISCN3 data contributions.*

```{r setup, message=FALSE, warning=FALSE}
library(SOCDRaH2)
library(tidyverse)
library(knitr)
library(ggplot2)
library(ggmap)
library(kableExtra)
dataDir <- '~/Desktop/Datasets/ISCN'

knitr::opts_chunk$set(eval=TRUE, echo=FALSE)
```

```{r load}
ISCN3.ls <- ISCN3_3(data_dir = dataDir) #this will throw an NA coercion warning that you can ignore
```

```{r summaries}
profile_summary <- ISCN3.ls$profile %>%
  select(dataset_name_sub, site_name) %>%
  unique()%>%
  group_by(dataset_name_sub) %>% 
  tally(name = 'profile_site_count')

layer_summary <- ISCN3.ls$layer %>%
  select(dataset_name_sub, site_name) %>%
  unique()%>%
  group_by(dataset_name_sub) %>% 
  tally(name = 'layer_site_count')

table_summary <- ISCN3.ls$study %>% 
  select(dataset_name, `dataset_type (dataset_type)`, dataset_description) %>%
  unique() %>%
  right_join(profile_summary %>%
              full_join(layer_summary, by = 'dataset_name_sub'), by=c('dataset_name' = 'dataset_name_sub'))

knitr::kable(table_summary %>%
    arrange(layer_site_count), 
  caption = 'Site counts for each contributing dataset submision (dataname_sub) in the profile and layer data table.')%>%
  kable_styling()
```

# Data Contributions

## TEMPLATE (`data_name_sub identifier`)

The TEMPLATE dataset is cited or uncited.
This data set is located in the United States and has XXX layer-level observations and YYY profile-level observations of ZZZ unique latitude-longitude locations in the layer-level table and AAA in the profile-level table.

*To use this section remove the code chunk eval arguments and set the current_dataset to the right identifier.*

```{r eval=FALSE}
#subset the data
current_dataset <- "Template"

study <- ISCN3.ls$study %>% 
  filter(dataset_name == current_dataset) %>%
  select(where(~any(!is.na(.)))) %>%
  t()

profile <- ISCN3.ls$profile %>%
  filter(dataset_name_sub == current_dataset)%>%
  select(where(~any(!is.na(.))))

layer <- ISCN3.ls$layer %>%
  filter(dataset_name_sub == current_dataset) %>%
  select(where(~any(!is.na(.))))

locations <- layer %>%
              select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`)%>% #) %>%
  unique() %>%
  filter(is.finite(`lat (dec. deg)` + `long (dec. deg)`))

if(any(ISCN3.ls$profile$dataset_name_sub == current_dataset)){
  
  locations <- profile %>% 
    select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`) %>%
    bind_rows(locations) %>%
    unique() %>%
    filter(is.finite(`lat (dec. deg)` + `long (dec. deg)`))
}

#Check to see if there is different/new information in the layer table that is not in the profile
#profile_info_layer <- layer %>%
#  select(any_of(setdiff(names(profile), c("layer_top (cm)", "layer_bot (cm)", "soc (g cm-2)")))) %>%
#  unique()
#
#series <- profile_info_layer %>% 
#  select(profile_name, soil_taxon, soil_series) %>% 
#  unique() %>%
#  anti_join(profile)
```

```{r eval=FALSE}
study %>%
  knitr::kable(caption = paste('Citations for the ', current_dataset, ' data set.'))

layer %>% select_if(is.factor) %>%
  pivot_longer(cols = everything(), names_to = 'column_name') %>%
  group_by_all() %>%
  tally() %>%
  knitr::kable(caption = 'Layer-level catagorical variable counts.')

if(nrow(profile) != 0) {
  profile %>% select_if(is.factor) %>%
    pivot_longer(cols = everything(), names_to = 'column_name') %>%
    group_by_all() %>%
    tally() %>%
    knitr::kable(caption = 'Profile-level catagorical variable counts.')
}
```

```{r eval=FALSE}
ggplot(locations) +
  geom_polygon(data = map_data('world'), aes(x=long, y = lat, group = group)) +
  geom_point(aes(x=`long (dec. deg)`, y = `lat (dec. deg)`), color = 'red', size = 3) +
  theme(axis.title = element_blank())

ggplot(data = layer %>%
         pivot_longer(cols = where(is.numeric) &
                        !ends_with('(dec. deg)'), #pull out the numerics that aren't lat/long
                      values_to = 'measurements', names_to = 'variable')) +
  geom_histogram(aes(x = measurements)) + #make a histrogram
  facet_wrap(~variable,scales = 'free')

ggplot(data = layer %>%
         pivot_longer(cols = where(is.numeric) & #pull out all the numerical colums
                        !starts_with('layer') & #as long as they aren't layer bounds
                        !ends_with('(dec. deg)'), #and aren't lat/lon
                      #create the paired measurement-variable tables
                      values_to = 'measurements', names_to = 'variable') %>%
         pivot_longer(cols = c('layer_top (cm)',
                               'layer_bot (cm)',), #pull out the layers
                      #create a paired depth-variable
                      values_to='depth', names_to = 'layer_variable')) +
  #make nifty line plots that span the layer boundaries
  geom_line(aes(x = depth, y = measurements,
                 group = paste(dataset_name_sub, site_name, profile_name))) +
  facet_wrap(~variable,scales = 'free')
```

### Fixed issues

*Copy this from the data report*
  
### Future issues

*Copy this from the data report*

None we are aware of

## NRCS_Sept2014(`NRCS_Sept2014`)

## WorldwideSCND(`WorldwideSCND`)

## USGS_S3C

## AK_DSC

## Jorgensen_NPS

## NCSCD

## Jorgensen_ARCN

## Bockheim

## PCN

## Lehmann_NE_US_soils

## USDA-FS_NRS_LandscapeCarbonInventory

## Jorgensen_YKDE

## Boby_Mack (`Boby_Mack`)
 See @Boby2010 for additional details and if you are using ISCN3 please cite.
This data set is located in the United States and has XXX layer level observations and YYY profile-level observations of ZZZ unique latitude-longitude locations in the layer-level table and AAA in the profile-level table.
```{r}
#subset the data
current_dataset <- "Boby_Mack"
study <- ISCN3.ls$study %>% 
  filter(dataset_name == current_dataset) %>%
  select(where(~any(!is.na(.)))) %>%
  t()
profile <- ISCN3.ls$profile %>%
  filter(dataset_name_sub == current_dataset)%>%
  select(where(~any(!is.na(.))))
layer <- ISCN3.ls$layer %>%
  filter(dataset_name_sub == current_dataset) %>%
  select(where(~any(!is.na(.))))
locations <- layer %>%
              select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`)%>% #) %>%
  unique() %>%
  filter(is.finite(`lat (dec. deg)` + `long (dec. deg)`))

if (any(ISCN3.ls$profile$dataset_name_sub == current_dataset)){
locations <- profile %>% 
  select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`) %>%
  bind_rows(locations) %>%
  unique() %>%
  filter(is.finite(`lat (dec. deg)` + `long (dec. deg)`))
}
#Check to see if there is different/new information in the layer table that is not in the profile
#profile_info_layer <- layer %>%
#  select(any_of(setdiff(names(profile), c("layer_top (cm)", "layer_bot (cm)", "soc (g cm-2)")))) %>%
#  unique()
#
#series <- profile_info_layer %>% 
#  select(profile_name, soil_taxon, soil_series) %>% 
#  unique() %>%
#  anti_join(profile)
```

```{r}
study %>%
  knitr::kable(caption = paste('Citations for the ', current_dataset, ' data set.'))
layer %>% select_if(is.factor) %>%
  pivot_longer(cols = everything(), names_to = 'column_name') %>%
  group_by_all() %>%
  tally() %>%
  knitr::kable(caption = 'Layer-level catagorical variable counts.')
if (nrow(profile) != 0){
profile %>% select_if(is.factor) %>%
  pivot_longer(cols = everything(), names_to = 'column_name') %>%
  group_by_all() %>%
  tally() %>%
  knitr::kable(caption = 'Profile-level catagorical variable counts.')
}
```

```{r}
ggplot(locations) +
  geom_polygon(data = map_data('world'), aes(x=long, y = lat, group = group)) +
  geom_point(aes(x=`long (dec. deg)`, y = `lat (dec. deg)`), color = 'red', size = 3) +
  theme(axis.title = element_blank())
ggplot(data = layer %>%
         pivot_longer(cols = where(is.numeric) & #pull out all the numerical colums
                        !starts_with('layer') & #as long as they aren't layer bounds
                        !ends_with('(dec. deg)'), #and aren't lat/lon
                      #create the paired measurement-variable tables
                      values_to = 'measurements', names_to = 'variable') %>%
         pivot_longer(cols = c('layer_top (cm)',
                               'layer_bot (cm)',), #pull out the layers
                      #create a paired depth-variable
                      values_to='depth', names_to = 'layer_variable')) +
  #make nifty line plots that span the layer boundaries
  geom_line(aes(x = depth, y = measurements,
                 group = paste(dataset_name_sub, site_name, profile_name))) +
  facet_wrap(~variable,scales = 'free')
```

### Fixed issues
Below is a list of know issues that were addressed between ISCN 3 and ISCN 3.3
  + Repeated information on soil carbon stocks was removed from the layer and profile information of the data set. 
  + There are no duplicate rows that needed to be removed, however, the soil carbon stock columns gap filled by ISCN were removed by ISCN3.5 cleaning. 
  + The site note in the data set profile was expanded to a formal citation and added to the ISCN bib file.
  + Note that data recorded as "Unknown" or "?" was left as is and NOT shifted to an NA value.
  + In profile, the ISCN SOC to 1m computation rows were removed, getting rid of duplicate data
  
### Future issues

None we are aware of

## Lehmann_Soil_CBC_1

## USGS_Harden

## Bonanza_LTER (`Bonanza LTER`)

The Bonanza_LTER dataset references @Cleve1993 and @Yarie2013.
This data set is located in the United States and has 583 layer level observations and 44 profile-level observations of ZZZ unique latitude-longitude locations in the layer-level table and AAA in the profile-level table.

```{r}
#subset the data
current_dataset <- "Bonanza LTER"

study <- ISCN3.ls$study %>% 
  filter(dataset_name == current_dataset) %>%
  select(where(~any(!is.na(.)))) %>%
  t()

profile <- ISCN3.ls$profile %>%
  filter(dataset_name_sub == current_dataset)%>%
  select(where(~any(!is.na(.))))

layer <- ISCN3.ls$layer %>%
  filter(dataset_name_sub == current_dataset) %>%
  select(where(~any(!is.na(.))))

locations <- profile %>% 
  select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`) %>%
  bind_rows(layer %>%
              select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`)) %>%
  unique() %>%
  filter(is.finite(`lat (dec. deg)` + `long (dec. deg)`))

#Check to see if there is different/new information in the layer table that is not in the profile
#profile_info_layer <- layer %>%
#  select(any_of(setdiff(names(profile), c("layer_top (cm)", "layer_bot (cm)", "soc (g cm-2)")))) %>%
#  unique()
#
#series <- profile_info_layer %>% 
#  select(profile_name, soil_taxon, soil_series) %>% 
#  unique() %>%
#  anti_join(profile)
```



```{r}
study %>%
  knitr::kable(caption = paste('Citations for the ', current_dataset, ' data set.'))

layer %>% select_if(is.factor) %>%
  pivot_longer(cols = everything(), names_to = 'column_name') %>%
  group_by_all() %>%
  tally() %>%
  knitr::kable(caption = 'Layer-level catagorical variable counts.')

profile %>% select_if(is.factor) %>%
  pivot_longer(cols = everything(), names_to = 'column_name') %>%
  group_by_all() %>%
  tally() %>%
  knitr::kable(caption = 'Profile-level catagorical variable counts.')
```




```{r}
ggplot(locations) +
  geom_polygon(data = map_data('world'), aes(x=long, y = lat, group = group)) +
  geom_point(aes(x=`long (dec. deg)`, y = `lat (dec. deg)`), color = 'red', size = 3) +
  theme(axis.title = element_blank())

ggplot(data = layer %>%
         pivot_longer(cols = where(is.numeric) & #pull out all the numerical colums
                        !starts_with('layer') & #as long as they aren't layer bounds
                        !ends_with('(dec. deg)'), #and aren't lat/lon
                      #create the paired measurement-variable tables
                      values_to = 'measurements', names_to = 'variable') %>%
         pivot_longer(cols = c('layer_top (cm)',
                               'layer_bot (cm)',), #pull out the layers
                      #create a paired depth-variable
                      values_to='depth', names_to = 'layer_variable')) +
  #make nifty line plots that span the layer boundaries
  geom_line(aes(x = depth, y = measurements,
                 group = paste(dataset_name_sub, site_name, profile_name))) +
  facet_wrap(~variable,scales = 'free')
```

### Fixed issues

Below is a list of know issues that were addressed between ISCN 3 and ISCN 3.3

  + In the dataset_profile, SOC computed values were removed and duplicate entries were removed. 
  + In the dataset_layer, SOC computed values were removed.
  
### Future issues

  + Data citation present, import directly from EDI for ISCN4


## Lu_LTER(`Lu_LTER`)

The Lu_LTER data set references @Ping2000, @Ping2002, @Ping2004, @Ping2005, and @Michaelson1996.
The `Lu_LTER` data set in ISCN3 contains 103 layer-level observations and 14 profile-level observations after cleaning for ISCN3.5.

```{r}
current_dataset <- "Lu_LTER"

study <- ISCN3.ls$study %>% 
  filter(dataset_name == current_dataset) %>%
  select(where(~any(!is.na(.)))) %>%
  t()

profile <- ISCN3.ls$profile %>%
  filter(dataset_name_sub == current_dataset)%>%
  select(where(~any(!is.na(.))))

layer <- ISCN3.ls$layer %>%
  filter(dataset_name_sub == current_dataset) %>%
  select(where(~any(!is.na(.))))

locations <- layer %>% 
    select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`) %>%
    bind_rows(layer %>%
                select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`)) %>%
    unique() %>%
    filter(is.finite(`lat (dec. deg)` + `long (dec. deg)`))

if(any(ISCN3.ls$profile$dataset_name_sub == current_dataset)) {
  locations <- profile %>% 
    select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`) %>%
    bind_rows(locations) %>%
    unique() %>%
    filter(is.finite(`lat (dec. deg)` + `long (dec. deg)`))
}

#Check to see if there is different/new information in the layer table that is not in the profile
#profile_info_layer <- layer %>%
#  select(any_of(setdiff(names(profile), c("layer_top (cm)", "layer_bot (cm)", "soc (g cm-2)")))) %>%
#  unique()
#
#series <- profile_info_layer %>% 
#  select(profile_name, soil_taxon, soil_series) %>% 
#  unique() %>%
#  anti_join(profile)
```

```{r}
study %>%
  knitr::kable(caption = paste('Citations for the ', current_dataset, ' data set.'))

layer %>% select_if(is.factor) %>%
  pivot_longer(cols = everything(), names_to = 'column_name') %>%
  group_by_all() %>%
  tally() %>%
  knitr::kable(caption = 'Layer-level catagorical variable counts.')

if(nrow(profile) != 0) {
  profile %>% select_if(is.factor) %>%
    pivot_longer(cols = everything(), names_to = 'column_name') %>%
    group_by_all() %>%
    tally() %>%
    knitr::kable(caption = 'Profile-level catagorical variable counts.')
}
```

```{r}
ggplot(locations) +
  geom_polygon(data = map_data('world'), aes(x=long, y = lat, group = group)) +
  geom_point(aes(x=`long (dec. deg)`, y = `lat (dec. deg)`), color = 'red', size = 3) +
  theme(axis.title = element_blank())

ggplot(data = layer %>%
         pivot_longer(cols = where(is.numeric) &
                        !ends_with('(dec. deg)'), #pull out the numerics that aren't lat/long
                      values_to = 'measurements', names_to = 'variable')) +
  geom_histogram(aes(x = measurements)) + #make a histrogram
  facet_wrap(~variable,scales = 'free')

ggplot(data = layer %>%
         pivot_longer(cols = where(is.numeric) & #pull out all the numerical colums
                        !starts_with('layer') & #as long as they aren't layer bounds
                        !ends_with('(dec. deg)'), #and aren't lat/lon
                      #create the paired measurement-variable tables
                      values_to = 'measurements', names_to = 'variable') %>%
         pivot_longer(cols = c('layer_top (cm)',
                               'layer_bot (cm)',), #pull out the layers
                      #create a paired depth-variable
                      values_to='depth', names_to = 'layer_variable')) +
  #make nifty line plots that span the layer boundaries
  geom_line(aes(x = depth, y = measurements,
                 group = paste(dataset_name_sub, site_name, profile_name))) +
  facet_wrap(~variable,scales = 'free')
```

### Fixed issues

Below is a list of know issues that were addressed between ISCN 3 and ISCN 3.3

  + In profile, the ISCN SOC to 1m computation rows were removed, as well as any resulting duplicate data.
  
### Future issues

None we are aware of


## HeckmanSwanstonBiscuitBurn


## Kane (`Kane`)
Please see @Kane2004, @Kane2005, @Kane2009, and @Valentine2004 for additional details.
This data set is located in the United States and has 574 layer level observations and 144 profile-level observations of ZZZ unique latitude-longitude locations in the layer-level table and AAA in the profile-level table.

```{r}
#subset the data
current_dataset <- "Kane"
study <- ISCN3.ls$study %>% 
  filter(dataset_name == current_dataset) %>%
  select(where(~any(!is.na(.)))) %>%
  t()
profile <- ISCN3.ls$profile %>%
  filter(dataset_name_sub == current_dataset)%>%
  select(where(~any(!is.na(.))))
layer <- ISCN3.ls$layer %>%
  filter(dataset_name_sub == current_dataset) %>%
  select(where(~any(!is.na(.))))
locations <- profile %>% 
  select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`) %>%
  bind_rows(layer %>%
              select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`)) %>%
  unique() %>%
  filter(is.finite(`lat (dec. deg)` + `long (dec. deg)`))
#Check to see if there is different/new information in the layer table that is not in the profile
#profile_info_layer <- layer %>%
#  select(any_of(setdiff(names(profile), c("layer_top (cm)", "layer_bot (cm)", "soc (g cm-2)")))) %>%
#  unique()
#
#series <- profile_info_layer %>% 
#  select(profile_name, soil_taxon, soil_series) %>% 
#  unique() %>%
#  anti_join(profile)
```

```{r}
study %>%
  knitr::kable(caption = paste('Citations for the ', current_dataset, ' data set.'))
layer %>% select_if(is.factor) %>%
  pivot_longer(cols = everything(), names_to = 'column_name') %>%
  group_by_all() %>%
  tally() %>%
  knitr::kable(caption = 'Layer-level catagorical variable counts.')
profile %>% select_if(is.factor) %>%
  pivot_longer(cols = everything(), names_to = 'column_name') %>%
  group_by_all() %>%
  tally() %>%
  knitr::kable(caption = 'Profile-level catagorical variable counts.')
```

```{r}
ggplot(locations) +
  geom_polygon(data = map_data('world'), aes(x=long, y = lat, group = group)) +
  geom_point(aes(x=`long (dec. deg)`, y = `lat (dec. deg)`), color = 'red', size = 3) +
  theme(axis.title = element_blank())
ggplot(data = layer %>%
         pivot_longer(cols = where(is.numeric) & #pull out all the numerical colums
                        !starts_with('layer') & #as long as they aren't layer bounds
                        !ends_with('(dec. deg)'), #and aren't lat/lon
                      #create the paired measurement-variable tables
                      values_to = 'measurements', names_to = 'variable') %>%
         pivot_longer(cols = c('layer_top (cm)',
                               'layer_bot (cm)',), #pull out the layers
                      #create a paired depth-variable
                      values_to='depth', names_to = 'layer_variable')) +
  #make nifty line plots that span the layer boundaries
  geom_line(aes(x = depth, y = measurements,
                 group = paste(dataset_name_sub, site_name, profile_name))) +
  facet_wrap(~variable,scales = 'free')
```

### Fixed issues
Below is a list of know issues that were addressed between ISCN 3 and ISCN 3.3
  + Rows weren't removed from ISCN3 because there were no duplicated entries within the layer-level and profile-level information.
  + Columns were removed from ISCN3 where information was not available throughout the data set.
  + Unclear information on vegetation remains in the `vegclass_local` section of the layer-level and profile-level information.
  + This data set required the use of a map centered around Alaska. 
  + In profile, the ISCN SOC to 1m computation rows were removed, getting rid of duplicate data
  
### Future issues
  + Inquire about cryptic vegetation information located in the `vegclass_local` columns
  + Include the two data citations
    The two urls provided lead to 404 error pages.
    citation [2]: https://search.dataone.org/view/https%3A%2F%2Fpasta.lternet.edu%2Fpackage%2Fmetadata%2Feml%2Fknb-lter-bnz%2F133%2F19
                  or
                  https://search.dataone.org/view/https%3A%2F%2Fpasta.lternet.edu%2Fpackage%2Fmetadata%2Feml%2Fknb-lter-bnz%2F133%2F18
                    Looks like same datasets with two different DOI's - contact repository to see if they want this handled a certain way
    citation [4]: https://search.dataone.org/view/https%3A%2F%2Fpasta.lternet.edu%2Fpackage%2Fmetadata%2Feml%2Fknb-lter-bnz%2F132%2F18
          Download URL: https://pasta.lternet.edu/package/data/eml/knb-lter-bnz/132/18/e9bb75742dedc686e224c41ea6e33ad8   - the twelve pits data
                        AND
                        https://pasta.lternet.edu/package/data/eml/knb-lter-bnz/132/18/fc7153b558a9fa8d1f02ff61f8231fde   - biophysical data and GPS coordinates


## Lu_PIMA (`Lu_PIMA`)

The `Lu_PIMA` data set references @Ping2010.
This dataset contains 69 layer-level information and 0 profile-level observations of 11 unique latitude-longitude locations in the layer-level table.

```{r}
#subset the data
current_dataset <- "Lu_PIMA"

study <- ISCN3.ls$study %>% 
  filter(dataset_name == current_dataset) %>%
  select(where(~any(!is.na(.)))) %>%
  t()

profile <- ISCN3.ls$profile %>%
  filter(dataset_name_sub == current_dataset)%>%
  select(where(~any(!is.na(.))))

layer <- ISCN3.ls$layer %>%
  filter(dataset_name_sub == current_dataset) %>%
  select(where(~any(!is.na(.))))

locations <- layer %>% 
    select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`) %>%
    bind_rows(layer %>%
                select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`)) %>%
    unique() %>%
    filter(is.finite(`lat (dec. deg)` + `long (dec. deg)`))

if(any(ISCN3.ls$profile$dataset_name_sub == current_dataset)) {
  locations <- profile %>% 
    select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`) %>%
    bind_rows(locations) %>%
    unique() %>%
    filter(is.finite(`lat (dec. deg)` + `long (dec. deg)`))
}

#Check to see if there is different/new information in the layer table that is not in the profile
#profile_info_layer <- layer %>%
#  select(any_of(setdiff(names(profile), c("layer_top (cm)", "layer_bot (cm)", "soc (g cm-2)")))) %>%
#  unique()
#
#series <- profile_info_layer %>% 
#  select(profile_name, soil_taxon, soil_series) %>% 
#  unique() %>%
#  anti_join(profile)
```

```{r}
study %>%
  knitr::kable(caption = paste('Citations for the ', current_dataset, ' data set.'))

layer %>% select_if(is.factor) %>%
  pivot_longer(cols = everything(), names_to = 'column_name') %>%
  group_by_all() %>%
  tally() %>%
  knitr::kable(caption = 'Layer-level catagorical variable counts.')

if(nrow(profile) != 0) {
  profile %>% select_if(is.factor) %>%
    pivot_longer(cols = everything(), names_to = 'column_name') %>%
    group_by_all() %>%
    tally() %>%
    knitr::kable(caption = 'Profile-level catagorical variable counts.')
}
```

```{r}
ggplot(locations) +
  geom_polygon(data = map_data('world'), aes(x=long, y = lat, group = group)) +
  geom_point(aes(x=`long (dec. deg)`, y = `lat (dec. deg)`), color = 'red', size = 3) +
  theme(axis.title = element_blank())

ggplot(data = layer %>%
         pivot_longer(cols = where(is.numeric) &
                        !ends_with('(dec. deg)'), #pull out the numerics that aren't lat/long
                      values_to = 'measurements', names_to = 'variable')) +
  geom_histogram(aes(x = measurements)) + #make a histrogram
  facet_wrap(~variable,scales = 'free')

ggplot(data = layer %>%
         pivot_longer(cols = where(is.numeric) & #pull out all the numerical colums
                        !starts_with('layer') & #as long as they aren't layer bounds
                        !ends_with('(dec. deg)'), #and aren't lat/lon
                      #create the paired measurement-variable tables
                      values_to = 'measurements', names_to = 'variable') %>%
         pivot_longer(cols = c('layer_top (cm)',
                               'layer_bot (cm)',), #pull out the layers
                      #create a paired depth-variable
                      values_to='depth', names_to = 'layer_variable')) +
  #make nifty line plots that span the layer boundaries
  geom_line(aes(x = depth, y = measurements,
                 group = paste(dataset_name_sub, site_name, profile_name))) +
  facet_wrap(~variable,scales = 'free')
```

### Fixed issues

  + In profile, the ISCN SOC to 1m computation rows were removed, getting rid of duplicate data.
  + The layer tables were adjusted to reassign the value "NA" to a column with "?".
  + The clean layer and clean profile table were checked for accuracy of information.
  + A citation was added to the bibliography file.
  + Four columns were removed from the original dataset that remove the soc columns from both the dataset_layer table and dataset_profile table.
  
### Future issues
  + Cite a database referenced in the dataset_study table
  + The url links provided lead to a 404 error page. The correct url for dataone: https://search.dataone.org/view/knb-lter-bnz.366.16
  + The datasite download link provided: http://www.lter.uaf.edu/404.php
          This link leads to a 404 error, contacting the researchers is necessary.


## USGS Harden Yazoo (`USGS Harden Yazoo`)

The USGS Harden Yazoo dataset references @Harden1999 and @Huntington1998.
This data set is located in the United States and has 234 layer level observations and 17 profile-level observations of 4 unique latitude-longitude locations in the layer-level table and AAA in the profile-level table.

*To use this section remove the code chunk eval arguments and set the current_dataset to the right identifier.*

```{r}
#subset the data
current_dataset <- "USGS Harden Yazoo"
study <- ISCN3.ls$study %>% 
  filter(dataset_name == current_dataset) %>%
  select(where(~any(!is.na(.)))) %>%
  t()
profile <- ISCN3.ls$profile %>%
  filter(dataset_name_sub == current_dataset)%>%
  select(where(~any(!is.na(.))))
layer <- ISCN3.ls$layer %>%
  filter(dataset_name_sub == current_dataset) %>%
  select(where(~any(!is.na(.))))
locations <- layer %>% 
    select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`) %>%
    bind_rows(layer %>%
                select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`)) %>%
    unique() %>%
    filter(is.finite(`lat (dec. deg)` + `long (dec. deg)`))
if(any(ISCN3.ls$profile$dataset_name_sub == current_dataset)) {
  locations <- profile %>% 
    select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`) %>%
    bind_rows(locations) %>%
    unique() %>%
    filter(is.finite(`lat (dec. deg)` + `long (dec. deg)`))
}
#Check to see if there is different/new information in the layer table that is not in the profile
#profile_info_layer <- layer %>%
#  select(any_of(setdiff(names(profile), c("layer_top (cm)", "layer_bot (cm)", "soc (g cm-2)")))) %>%
#  unique()
#
#series <- profile_info_layer %>% 
#  select(profile_name, soil_taxon, soil_series) %>% 
#  unique() %>%
#  anti_join(profile)
```

```{r}
study %>%
  knitr::kable(caption = paste('Citations for the ', current_dataset, ' data set.'))
layer %>% select_if(is.factor) %>%
  pivot_longer(cols = everything(), names_to = 'column_name') %>%
  group_by_all() %>%
  tally() %>%
  knitr::kable(caption = 'Layer-level catagorical variable counts.')
if(nrow(profile) != 0) {
  profile %>% select_if(is.factor) %>%
    pivot_longer(cols = everything(), names_to = 'column_name') %>%
    group_by_all() %>%
    tally() %>%
    knitr::kable(caption = 'Profile-level catagorical variable counts.')
}
```

```{r}
ggplot(locations) +
  geom_polygon(data = map_data('world'), aes(x=long, y = lat, group = group)) +
  geom_point(aes(x=`long (dec. deg)`, y = `lat (dec. deg)`), color = 'red', size = 3) +
  theme(axis.title = element_blank())
ggplot(data = layer %>%
         pivot_longer(cols = where(is.numeric) &
                        !ends_with('(dec. deg)'), #pull out the numerics that aren't lat/long
                      values_to = 'measurements', names_to = 'variable')) +
  geom_histogram(aes(x = measurements)) + #make a histrogram
  facet_wrap(~variable,scales = 'free')
ggplot(data = layer %>%
         pivot_longer(cols = where(is.numeric) & #pull out all the numerical colums
                        !starts_with('layer') & #as long as they aren't layer bounds
                        !ends_with('(dec. deg)'), #and aren't lat/lon
                      #create the paired measurement-variable tables
                      values_to = 'measurements', names_to = 'variable') %>%
         pivot_longer(cols = c('layer_top (cm)',
                               'layer_bot (cm)',), #pull out the layers
                      #create a paired depth-variable
                      values_to='depth', names_to = 'layer_variable')) +
  #make nifty line plots that span the layer boundaries
  geom_line(aes(x = depth, y = measurements,
                 group = paste(dataset_name_sub, site_name, profile_name))) +
  facet_wrap(~variable,scales = 'free')
```

### Fixed issues

  + Half of the rows (234) of dataset_layer were removed from ISCN3 because they were repetitive entries from ISCN stock computation.
  + 3 columns of dataset_layer were removed from ISCN3 because they were determined using soc.
  + 17 rows of dataset_profile were removed from ISCN3 because they were filled using ISCN stock computation.
  + 5 columns of dataset_profile were removed from ISCN 3 because they were determined using soc.
  + Values in column  country (country) were reassigned to "united States" in the dataset_layer and dataset_profile tables because it was the known location of the collection state.
  + Values in the "hzn" column of the dataset_layer table were reassigned to an NA character from "?", a nonspecific character.
  + Ggplot maps were modified to ensure datasets accurately focused on Southeastern United States.
  + Cryptic site notes in dataset_profile table were resolved to contain full citations.
  
### Future issues

  + Fix remaining SOC column in Dataset_layer table?


## Vogel (`Vogel`)

The Vogel dataset references @Kane2009, @Vogel2007, and @Vogel2008.
This data set is located in the United States and has 230 layer level observations and YYY profile-level observations of ZZZ unique latitude-longitude locations in the layer-level table and AAA in the profile-level table.

```{r}
#subset the data
current_dataset <- "Vogel"

study <- ISCN3.ls$study %>% 
  filter(dataset_name == current_dataset) %>%
  select(where(~any(!is.na(.)))) %>%
  t()

profile <- ISCN3.ls$profile %>%
  filter(dataset_name_sub == current_dataset)%>%
  select(where(~any(!is.na(.))))

layer <- ISCN3.ls$layer %>%
  filter(dataset_name_sub == current_dataset) %>%
  select(where(~any(!is.na(.))))

locations <- layer %>% 
    select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`) %>%
    bind_rows(layer %>%
                select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`)) %>%
    unique() %>%
    filter(is.finite(`lat (dec. deg)` + `long (dec. deg)`))

if (any(ISCN3.ls$profile$dataset_name_sub == current_dataset)) {
  locations <- profile %>% 
    select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`) %>%
    bind_rows(locations) %>%
    unique() %>%
    filter(is.finite(`lat (dec. deg)` + `long (dec. deg)`))
}

#Check to see if there is different/new information in the layer table that is not in the profile
#profile_info_layer <- layer %>%
#  select(any_of(setdiff(names(profile), c("layer_top (cm)", "layer_bot (cm)", "soc (g cm-2)")))) %>%
#  unique()
#
#series <- profile_info_layer %>% 
#  select(profile_name, soil_taxon, soil_series) %>% 
#  unique() %>%
#  anti_join(profile)
```



```{r}
study %>%
  knitr::kable(caption = paste('Citations for the ', current_dataset, ' data set.'))

layer %>% select_if(is.factor) %>%
  pivot_longer(cols = everything(), names_to = 'column_name') %>%
  group_by_all() %>%
  tally() %>%
  knitr::kable(caption = 'Layer-level catagorical variable counts.')

if (nrow(profile) != 0)
{
  profile %>% select_if(is.factor) %>%
    pivot_longer(cols = everything(), names_to = 'column_name') %>%
    group_by_all() %>%
    tally() %>%
    knitr::kable(caption = 'Profile-level catagorical variable counts.')
}
```




```{r}
ggplot(locations) +
  geom_polygon(data = map_data('world'), aes(x=long, y = lat, group = group)) +
  geom_point(aes(x=`long (dec. deg)`, y = `lat (dec. deg)`), color = 'red', size = 3) +
  theme(axis.title = element_blank())

ggplot(data = layer %>%
         pivot_longer(cols = where(is.numeric) & #pull out all the numerical colums
                        !starts_with('layer') & #as long as they aren't layer bounds
                        !ends_with('(dec. deg)'), #and aren't lat/lon
                      #create the paired measurement-variable tables
                      values_to = 'measurements', names_to = 'variable') %>%
         pivot_longer(cols = c('layer_top (cm)',
                               'layer_bot (cm)',), #pull out the layers
                      #create a paired depth-variable
                      values_to='depth', names_to = 'layer_variable')) +
  #make nifty line plots that span the layer boundaries
  geom_line(aes(x = depth, y = measurements,
                 group = paste(dataset_name_sub, site_name, profile_name))) +
  facet_wrap(~variable,scales = 'free')
```

### Fixed issues

Below is a list of know issues that were addressed between ISCN 3 and ISCN 3.3

  + ISCN3 removed repeated information in citations, which was corrected and filled for ISCN3.5.
  + ISCN3 also filled in the soil carbon stocks where bulk density and organic carbon was provided, this was removed for ISCN3.5.
  + This data set was set in Alaska, so the Alaska Location code from the Template was used instead of the generic.
  
### Future issues

  + Find out where temperature and precipitation data is (currently not on ISCN)

## USGS Muhs (`USGS Muhs`)

The USGS Muhs dataset references @Muhs2003.
This data set is located in the United States and has 395 layer level observations and YYY profile-level observations of 4 unique latitude-longitude locations in the layer-level table and AAA in the profile-level table.

```{r}
#subset the data
current_dataset <- "USGS Muhs"
study <- ISCN3.ls$study %>% 
  filter(dataset_name == current_dataset) %>%
  select(where(~any(!is.na(.)))) %>%
  t()
profile <- ISCN3.ls$profile %>%
  filter(dataset_name_sub == current_dataset)%>%
  select(where(~any(!is.na(.))))
layer <- ISCN3.ls$layer %>%
  filter(dataset_name_sub == current_dataset) %>%
  select(where(~any(!is.na(.))))
locations <- layer %>% 
    select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`) %>%
    bind_rows(layer %>%
                select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`)) %>%
    unique() %>%
    filter(is.finite(`lat (dec. deg)` + `long (dec. deg)`))
if(any(ISCN3.ls$profile$dataset_name_sub == current_dataset)) {
  locations <- profile %>% 
    select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`) %>%
    bind_rows(locations) %>%
    unique() %>%
    filter(is.finite(`lat (dec. deg)` + `long (dec. deg)`))
}
#Check to see if there is different/new information in the layer table that is not in the profile
#profile_info_layer <- layer %>%
#  select(any_of(setdiff(names(profile), c("layer_top (cm)", "layer_bot (cm)", "soc (g cm-2)")))) %>%
#  unique()
#
#series <- profile_info_layer %>% 
#  select(profile_name, soil_taxon, soil_series) %>% 
#  unique() %>%
#  anti_join(profile)
```

```{r}
study %>%
  knitr::kable(caption = paste('Citations for the ', current_dataset, ' data set.'))
layer %>% select_if(is.factor) %>%
  pivot_longer(cols = everything(), names_to = 'column_name') %>%
  group_by_all() %>%
  tally() %>%
  knitr::kable(caption = 'Layer-level catagorical variable counts.')
if(nrow(profile) != 0) {
  profile %>% select_if(is.factor) %>%
    pivot_longer(cols = everything(), names_to = 'column_name') %>%
    group_by_all() %>%
    tally() %>%
    knitr::kable(caption = 'Profile-level catagorical variable counts.')
}
```

```{r}
ggplot(locations) +
  geom_polygon(data = map_data('world'), aes(x=long, y = lat, group = group)) +
  geom_point(aes(x=`long (dec. deg)`, y = `lat (dec. deg)`), color = 'red', size = 3) +
  theme(axis.title = element_blank())
ggplot(data = layer %>%
         pivot_longer(cols = where(is.numeric) &
                        !ends_with('(dec. deg)'), #pull out the numerics that aren't lat/long
                      values_to = 'measurements', names_to = 'variable')) +
  geom_histogram(aes(x = measurements)) + #make a histrogram
  facet_wrap(~variable,scales = 'free')
ggplot(data = layer %>%
         pivot_longer(cols = where(is.numeric) & #pull out all the numerical colums
                        !starts_with('layer') & #as long as they aren't layer bounds
                        !ends_with('(dec. deg)'), #and aren't lat/lon
                      #create the paired measurement-variable tables
                      values_to = 'measurements', names_to = 'variable') %>%
         pivot_longer(cols = c('layer_top (cm)',
                               'layer_bot (cm)',), #pull out the layers
                      #create a paired depth-variable
                      values_to='depth', names_to = 'layer_variable')) +
  #make nifty line plots that span the layer boundaries
  geom_line(aes(x = depth, y = measurements,
                 group = paste(dataset_name_sub, site_name, profile_name))) +
  facet_wrap(~variable,scales = 'free')
```

### Fixed issues

  + Repeated information on soil carbon stocks was removed from the layer and profile information of the data set.
  + There are no duplicate rows that needed to be removed, however, the soil carbon stock columns gap filled by ISCN were removed by ISCN3.5 cleaning.
  + In addition, the site note in the data set profile was expanded to a formal citation and added to the ISCN bib file.
  
### Future issues

None we are aware of


## HeckmanLithosequence


## Schuur (`Schuur`)

The Schuur data set references @Schuur2007.
This data set is located in the United States and has 153 layer-level observations and 4 profile-level observations of 1 unique latitude-longitude location in the layer-level table and AAA in the profile-level table.

```{r}
current_dataset <- "Schuur"

study <- ISCN3.ls$study %>% 
  filter(dataset_name == current_dataset) %>%
  select(where(~any(!is.na(.)))) %>%
  t()

profile <- ISCN3.ls$profile %>%
  filter(dataset_name_sub == current_dataset)%>%
  select(where(~any(!is.na(.))))

layer <- ISCN3.ls$layer %>%
  filter(dataset_name_sub == current_dataset) %>%
  select(where(~any(!is.na(.))))

locations <- layer %>% 
    select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`) %>%
    bind_rows(layer %>%
                select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`)) %>%
    unique() %>%
    filter(is.finite(`lat (dec. deg)` + `long (dec. deg)`))

if(any(ISCN3.ls$profile$dataset_name_sub == current_dataset)) {
  locations <- profile %>% 
    select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`) %>%
    bind_rows(locations) %>%
    unique() %>%
    filter(is.finite(`lat (dec. deg)` + `long (dec. deg)`))
}

#Check to see if there is different/new information in the layer table that is not in the profile
#profile_info_layer <- layer %>%
#  select(any_of(setdiff(names(profile), c("layer_top (cm)", "layer_bot (cm)", "soc (g cm-2)")))) %>%
#  unique()
#
#series <- profile_info_layer %>% 
#  select(profile_name, soil_taxon, soil_series) %>% 
#  unique() %>%
#  anti_join(profile)
```

```{r}
study %>%
  knitr::kable(caption = paste('Citations for the ', current_dataset, ' data set.'))

layer %>% select_if(is.factor) %>%
  pivot_longer(cols = everything(), names_to = 'column_name') %>%
  group_by_all() %>%
  tally() %>%
  knitr::kable(caption = 'Layer-level catagorical variable counts.')

if(nrow(profile) != 0) {
  profile %>% select_if(is.factor) %>%
    pivot_longer(cols = everything(), names_to = 'column_name') %>%
    group_by_all() %>%
    tally() %>%
    knitr::kable(caption = 'Profile-level catagorical variable counts.')
}
```

```{r}
ggplot(locations) +
  geom_polygon(data = map_data('world'), aes(x=long, y = lat, group = group)) +
  geom_point(aes(x=`long (dec. deg)`, y = `lat (dec. deg)`), color = 'red', size = 3) +
  theme(axis.title = element_blank())

ggplot(data = layer %>%
         pivot_longer(cols = where(is.numeric) &
                        !ends_with('(dec. deg)'), #pull out the numerics that aren't lat/long
                      values_to = 'measurements', names_to = 'variable')) +
  geom_histogram(aes(x = measurements)) + #make a histrogram
  facet_wrap(~variable,scales = 'free')

ggplot(data = layer %>%
         pivot_longer(cols = where(is.numeric) & #pull out all the numerical colums
                        !starts_with('layer') & #as long as they aren't layer bounds
                        !ends_with('(dec. deg)'), #and aren't lat/lon
                      #create the paired measurement-variable tables
                      values_to = 'measurements', names_to = 'variable') %>%
         pivot_longer(cols = c('layer_top (cm)',
                               'layer_bot (cm)',), #pull out the layers
                      #create a paired depth-variable
                      values_to='depth', names_to = 'layer_variable')) +
  #make nifty line plots that span the layer boundaries
  geom_line(aes(x = depth, y = measurements,
                 group = paste(dataset_name_sub, site_name, profile_name))) +
  facet_wrap(~variable,scales = 'free')
```

### Fixed issues

In profile, the ISCN SOC to 1m computation rows were removed, getting rid of duplicate data.

### Future issues

None that we are aware of


## Myers_Smith

## OakRidgeNationalLab_Loblolly_DWJ

## OakRidgeNationalLab_TDE


## University of Michigan Biological Station Forest Accelerated Succession ExperimenT (`UMBS_FASET`)

The University of Michigan Biological Station Forest Accelerated Succession Experiment (`UMBS_FASET`) data set is uncited and unpublished.

This data set is located in the United States and has 405 layer-level observations and 137 profile-level observations of 1 unique latitude-longitude location.

```{r}
#subset the data
current_dataset <- "UMBS_FASET"

study <- ISCN3.ls$study %>% 
  filter(dataset_name == current_dataset) %>%
  select(where(~any(!is.na(.)))) %>%
  t()

profile <- ISCN3.ls$profile %>%
  filter(dataset_name_sub == current_dataset)%>%
  select(where(~any(!is.na(.))))

layer <- ISCN3.ls$layer %>%
  filter(dataset_name_sub == current_dataset) %>%
  select(where(~any(!is.na(.))))

locations <- layer %>% 
    select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`) %>%
    bind_rows(layer %>%
                select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`)) %>%
    unique() %>%
    filter(is.finite(`lat (dec. deg)` + `long (dec. deg)`))

if(any(ISCN3.ls$profile$dataset_name_sub == current_dataset)) {
  locations <- profile %>% 
    select(`lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`) %>%
    bind_rows(locations) %>%
    unique() %>%
    filter(is.finite(`lat (dec. deg)` + `long (dec. deg)`))
}

#Check to see if there is different/new information in the layer table that is not in the profile
#profile_info_layer <- layer %>%
#  select(any_of(setdiff(names(profile), c("layer_top (cm)", "layer_bot (cm)", "soc (g cm-2)")))) %>%
#  unique()
#
#series <- profile_info_layer %>% 
#  select(profile_name, soil_taxon, soil_series) %>% 
#  unique() %>%
#  anti_join(profile)
```

```{r}
study %>%
  knitr::kable(caption = paste('Citations for the ', current_dataset, ' data set.'))

layer %>% select_if(is.factor) %>%
  pivot_longer(cols = everything(), names_to = 'column_name') %>%
  group_by_all() %>%
  tally() %>%
  knitr::kable(caption = 'Layer-level catagorical variable counts.')

if(nrow(profile) != 0) {
  profile %>% select_if(is.factor) %>%
    pivot_longer(cols = everything(), names_to = 'column_name') %>%
    group_by_all() %>%
    tally() %>%
    knitr::kable(caption = 'Profile-level catagorical variable counts.')
}
```

```{r}
ggplot(locations) +
  geom_polygon(data = map_data('world'), aes(x=long, y = lat, group = group)) +
  geom_point(aes(x=`long (dec. deg)`, y = `lat (dec. deg)`), color = 'red', size = 3) +
  theme(axis.title = element_blank())

ggplot(data = layer %>%
         pivot_longer(cols = where(is.numeric) &
                        !ends_with('(dec. deg)'), #pull out the numerics that aren't lat/long
                      values_to = 'measurements', names_to = 'variable')) +
  geom_histogram(aes(x = measurements)) + #make a histrogram
  facet_wrap(~variable,scales = 'free')

ggplot(data = layer %>%
         pivot_longer(cols = where(is.numeric) & #pull out all the numerical colums
                        !starts_with('layer') & #as long as they aren't layer bounds
                        !ends_with('(dec. deg)'), #and aren't lat/lon
                      #create the paired measurement-variable tables
                      values_to = 'measurements', names_to = 'variable') %>%
         pivot_longer(cols = c('layer_top (cm)',
                               'layer_bot (cm)',), #pull out the layers
                      #create a paired depth-variable
                      values_to='depth', names_to = 'layer_variable')) +
  #make nifty line plots that span the layer boundaries
  geom_line(aes(x = depth, y = measurements,
                 group = paste(dataset_name_sub, site_name, profile_name))) +
  facet_wrap(~variable,scales = 'free')

#remove data from the layer that appears in the profile that is not the top/bottom/soc
#select all numerical data, pivot and histogram
#select all factor data and tally
```

### Fixed issues

Below is a list of known issues that were addressed between ISCN 3 and ISCN 3.3 for the University of Michigan Biological Station Forest Accelerated Succession Experiment (`UMBS_FASET`) data set.

  + The UMBS FASET data set is located in the United States and has 405 layer-level observations and 137 profile-level observations of 1 unique latitude-longitude location.
  + `ISCN SOC computation` soil organic carbon calculations were removed and duplicate rows deleted.
  + Values in the `hzn` column of the `layer` table were reassigned to an NA character from "?", a nonspecific character.
  + Values in  `country (country)` column were reassigned to "United States" in the `layer` and `profile` tables because it was the known location of the collection state.
  
### Future issues
  + Citation practices were initially incompatible with CC-BY license for ISCN3; contacting data providers about modifying release for ISCN4
  + Data is unpublished, and references "100 yrs of research." Revisit in ISCN 4. Check and see if data is still being collected at this research site
